# Deployment Guide

## üöÄ Overview

This guide provides step-by-step instructions for deploying the SharePoint Interactive Area Map using the **lock-and-key template system** with Power Automate. This approach creates a self-contained HTML file that works within SharePoint's dependency restrictions.

## üìã Prerequisites

### System Requirements
- **SharePoint Online** or **SharePoint Server 2019/2022**
- **Modern Experience** enabled (Classic mode supported with limitations)
- **Site Collection Administrator** or **Site Owner** permissions
- **Document Library** or **Site Pages** library for file hosting

### Browser Compatibility
- **Microsoft Edge** (Recommended)
- **Google Chrome** 88+
- **Mozilla Firefox** 85+
- **Safari** 14+ (macOS/iOS)

### File Dependencies
Template system requires these files:
```
AreaMap-PowerAutomate-Template.html  (Template with placeholders)
AreaMap-PowerAutomate-Config.json    (Configuration)
Artboard 1-3.svg                     (Updated map with A08, C08)
Build-AreaMap.ps1                    (Local testing script)

Generated Files:
AreaMap.html                         (Generated by Power Automate)
AreaMapAnalytics.csv                 (Auto-created analytics)
analytics-dashboard.html             (Admin dashboard)
```

## üîê Power Automate Setup Process

### Step 1: Prepare SharePoint Environment

1. **Create SharePoint Lists for Personnel and Analytics**
   
   **Personnel List:**
   ```
   List Name: "Personnel"
   Columns:
   - Title (Single line of text) - TRIGGERS REBUILD
   - UserEmail (Single line of text)
   - UserDisplayName (Single line of text) - TRIGGERS REBUILD
   - FirstName (Single line of text) - TRIGGERS REBUILD
   - LastName (Single line of text) - TRIGGERS REBUILD
   - PreferredFirstName (Single line of text) - TRIGGERS REBUILD
   - UserDepartment (Single line of text)
   - UserJobTitle (Single line of text) - TRIGGERS REBUILD
   - PrimaryAreaIDs (Multiple lines of text) - TRIGGERS REBUILD
   - SecondaryAreaIDs (Multiple lines of text) - TRIGGERS REBUILD
   - ManagerDisplayName (Single line of text) - TRIGGERS REBUILD
   - ManagerEmail (Single line of text) - TRIGGERS REBUILD
   - ManagerDepartment (Single line of text)
   - ManagerJobTitle (Single line of text)
   - IncludeOnMap (Yes/No, Default: Yes) - TRIGGERS REBUILD
   - LastMapUpdate (Date and Time)
   - TrainingAttendance (Multiple lines of text) - NO REBUILD
   - CertificationStatus (Choice) - NO REBUILD
   - LastLoginDate (Date and Time) - NO REBUILD
   - PersonalNotes (Multiple lines of text) - NO REBUILD
   - HRComments (Multiple lines of text) - NO REBUILD
   - EmergencyContact (Single line of text) - NO REBUILD
   ```
   
   **AreaMapAnalytics List:**
   ```
   List Name: "AreaMapAnalytics"
   Columns:
   - Title (Single line of text) - Auto-generated
   - ClickTimestamp (Date and Time) - Full timestamp
   - AreaCode (Single line of text) - A01, B05, C08, etc.
   - AreaName (Single line of text) - Human-readable name
   - Region (Choice: East, Central, West)
   - SessionId (Single line of text) - Browser session ID
   - UserAgent (Multiple lines of text) - Browser info
   - PageURL (Hyperlink) - URL where click occurred
   - ClickDate (Date Only) - For indexing
   - ClickHour (Number) - Hour 0-23 for analysis
   ```

2. **Upload Template Files**
   ```powershell
   # Upload template system files
   Add-PnPFile -Path ".\AreaMap-PowerAutomate-Template.html" -Folder "Documents"
   Add-PnPFile -Path ".\AreaMap-PowerAutomate-Config.json" -Folder "Documents"
   Add-PnPFile -Path ".\Artboard 1-3.svg" -Folder "Documents"
   Add-PnPFile -Path ".\Build-AreaMap.ps1" -Folder "Documents"
   ```

### Step 2: Create Power Automate Flow

#### Flow Configuration
```json
{
  "flowName": "AreaMap Generator",
  "trigger": {
    "type": "SharePoint",
    "event": "When an item is created or modified",
    "listName": "Personnel",
    "triggerCondition": "or(triggerColumnsList)",
    "triggerColumns": [
      "Title", "UserDisplayName", "FirstName", "LastName",
      "PreferredFirstName", "UserJobTitle", "PrimaryAreaIDs",
      "SecondaryAreaIDs", "ManagerDisplayName", "ManagerEmail",
      "IncludeOnMap"
    ],
    "excludeColumns": [
      "TrainingAttendance", "CertificationStatus", "LastLoginDate",
      "PersonalNotes", "HRComments", "EmergencyContact",
      "Created", "Modified", "ID"
    ],
    "condition": "IncludeOnMap eq true or IncludeOnMap changed"
  },
  "actions": [
    "Check for pending analytics",
    "Sync pending analytics to SharePoint list",
    "Get SharePoint list items (Personnel with IncludeOnMap=true)",
    "Get file content (Template)",
    "Get file content (SVG)",
    "Transform data to JSON",
    "Replace template placeholders",
    "Create or update AreaMap.html"
  ]
}
```

#### Flow Steps
1. **Trigger**: When Personnel list is modified (selective columns only)
2. **Condition Check**: Only proceed if IncludeOnMap=true user is affected
3. **Analytics Sync**: Save any pending analytics before rebuild
4. **Get Template**: Read AreaMap-PowerAutomate-Template.html
5. **Get SVG**: Read Artboard 1-3.svg content
6. **Get Data**: Retrieve Personnel items where IncludeOnMap=true
7. **Transform**: Convert data to JSON format
8. **Replace**: Fill template placeholders (including {{SITE_URL}})
9. **Output**: Write AreaMap.html to SharePoint
10. **Cleanup**: Update LastMapUpdate timestamps

### Step 3: Configure Template Placeholders

Create Power Automate expressions with selective triggers and analytics integration:

```javascript
// Personnel Data Filter Expression
filter(body('Get_Personnel_Items')?['value'], item()['IncludeOnMap'] eq true)

// Template Replacement Expression
replace(
  replace(
    replace(
      replace(
        body('Get_Template_Content'),
        '{{SVG_CONTENT}}', 
        body('Get_SVG_Content')
      ),
      '{{PERSONNEL_DATA}}',
      string(variables('FilteredPersonnelData'))
    ),
    '{{SITE_URL}}',
    triggerOutputs()?['body/webUrl']
  ),
  '{{TITLE}}',
  'Area Map - Personnel Query'
)

// Trigger Condition Expression (only rebuild for specific columns)
@{or(
  triggerOutputs()?['body/hasColumnChanged']?['Title'],
  triggerOutputs()?['body/hasColumnChanged']?['UserDisplayName'],
  triggerOutputs()?['body/hasColumnChanged']?['FirstName'],
  triggerOutputs()?['body/hasColumnChanged']?['LastName'],
  triggerOutputs()?['body/hasColumnChanged']?['PreferredFirstName'],
  triggerOutputs()?['body/hasColumnChanged']?['UserJobTitle'],
  triggerOutputs()?['body/hasColumnChanged']?['PrimaryAreaIDs'],
  triggerOutputs()?['body/hasColumnChanged']?['SecondaryAreaIDs'],
  triggerOutputs()?['body/hasColumnChanged']?['ManagerDisplayName'],
  triggerOutputs()?['body/hasColumnChanged']?['ManagerEmail'],
  triggerOutputs()?['body/hasColumnChanged']?['IncludeOnMap']
)}
```

### Step 4: Create Analytics Sync Flow

Create a separate flow for analytics management:

```json
{
  "flowName": "AreaMap Analytics Sync",
  "trigger": {
    "type": "Recurrence",
    "frequency": "Hour",
    "interval": 12
  },
  "actions": [
    "Get pending analytics from localStorage buffer",
    "Batch upload to AreaMapAnalytics list",
    "Clear localStorage buffer",
    "Update last sync timestamp"
  ]
}
```

### Step 5: Test Local Build (Optional)

Use the PowerShell script for local testing:

```powershell
.\Build-AreaMap.ps1 -C08AreaName "Central Texas" -EnableAnalytics
```

## üîê Permissions Configuration

### SharePoint List Permissions

#### Personnel List
- **Read Access**: Power Automate service account
- **Edit Access**: HR administrators + designated managers
- **View Access**: Area map administrators
- **Special**: IncludeOnMap column controls map visibility

#### AreaMapAnalytics List
- **Read Access**: Analytics viewers + site administrators
- **Write Access**: Power Automate service account + AreaMap application
- **View Access**: Analytics dashboard components

#### Template Files
- **Read Access**: Power Automate service account
- **Edit Access**: Site administrators only

#### Generated AreaMap.html
- **Read Access**: All authenticated users
- **Edit Access**: Power Automate service account only (auto-generated)

### SharePoint Permission Setup

```powershell
# Grant permissions using PowerShell
$web = Get-PnPWeb

# Set Personnel list permissions with IncludeOnMap control
$personnelList = Get-PnPList -Identity "Personnel"
Set-PnPListPermission -Identity $personnelList -User "HR Administrators" -AccessRights EditListItems
Set-PnPListPermission -Identity $personnelList -User "Power Automate Service" -AccessRights Read

# Set AreaMapAnalytics list permissions
$analyticsList = Get-PnPList -Identity "AreaMapAnalytics"
Set-PnPListPermission -Identity $analyticsList -User "Power Automate Service" -AccessRights AddListItems
Set-PnPListPermission -Identity $analyticsList -Group "Analytics Viewers" -AccessRights Read

# Set AreaMap.html permissions
$docList = Get-PnPList -Identity "Documents"
Set-PnPFileCheckedIn -Url "Documents/AreaMap.html"
Set-PnPListItemPermission -List $docList -Identity "AreaMap.html" -User "All Users" -AccessRights Read

# Restrict template files
Set-PnPListItemPermission -List $docList -Identity "AreaMap-PowerAutomate-Template.html" -Group "Site Owners" -AccessRights FullControl
```

## üîß Configuration Settings

### Update File Paths

If deploying to a subfolder, update file references:

```javascript
// In AreaMap.html, update SVG path
const svgPath = './subfolder/Artboard 1.svg';

// Update CSV paths
const personnelCsvPath = './subfolder/personnel_data.csv';
const analyticsCsvPath = './subfolder/AreaMapAnalytics.csv';
```

### SharePoint Context Configuration

```javascript
// Verify SharePoint context availability
if (typeof _spPageContextInfo !== 'undefined') {
    const webUrl = _spPageContextInfo.webAbsoluteUrl;
    const siteUrl = _spPageContextInfo.siteAbsoluteUrl;
    
    console.log('SharePoint context detected:', webUrl);
} else {
    console.warn('SharePoint context not available - running in standalone mode');
}
```

### Environment-Specific Settings

```javascript
const config = {
    production: {
        baseUrl: _spPageContextInfo.webAbsoluteUrl,
        enableAnalytics: true,
        debugMode: false
    },
    development: {
        baseUrl: 'http://localhost',
        enableAnalytics: false,
        debugMode: true
    }
};
```

## üîÑ Testing Procedures

### Pre-Deployment Testing

1. **Local File Testing**
   ```bash
   # Serve files locally for testing
   python -m http.server 8000
   # Navigate to http://localhost:8000/AreaMap.html
   ```

2. **SVG Loading Test**
   - Verify map displays correctly
   - Test area click functionality
   - Confirm hover effects work

3. **Personnel Data Test**
   - Upload sample personnel CSV
   - Test personnel queries
   - Verify modal displays

### Post-Deployment Validation

#### Functional Testing Checklist
- [ ] AreaMap.html loads without errors
- [ ] SVG map displays and is interactive
- [ ] Personnel queries return correct results  
- [ ] Analytics logging works (check console)
- [ ] Dashboard loads analytics data
- [ ] Permissions prevent unauthorized access

#### Performance Testing
```javascript
// Browser console tests
console.time('SVG Load');
// Measure SVG loading time

console.time('Personnel Query');
// Measure query performance

console.time('Analytics Write');
// Measure analytics logging speed
```

## üìä SharePoint Integration

### REST API Configuration

```javascript
// Configure REST API calls
const restConfig = {
    baseUrl: _spPageContextInfo.webAbsoluteUrl + "/_api",
    headers: {
        'Accept': 'application/json;odata=verbose',
        'Content-Type': 'application/json;odata=verbose',
        'X-RequestDigest': document.getElementById('__REQUESTDIGEST').value
    }
};
```

### List Integration (Optional)

For advanced scenarios, integrate with SharePoint lists:

```javascript
// Create Personnel list
const listCreationConfig = {
    Title: 'Personnel',
    BaseTemplate: 100, // Generic List
    Fields: [
        { Name: 'UserEmail', Type: 'Text' },
        { Name: 'PrimaryAreaIDs', Type: 'Note' },
        { Name: 'UserDepartment', Type: 'Text' }
    ]
};
```

## üîí Security Hardening

### Content Security Policy

Add to SharePoint master page or site settings:

```html
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    connect-src 'self' https:;
">
```

### File Upload Restrictions

```powershell
# Configure allowed file extensions
Set-PnPTenantSettings -AllowedFileExtensions @("html","svg","csv","js","css")
```

### Access Auditing

Enable auditing for analytics files:

```powershell
Set-PnPList -Identity "Documents" -EnableAttachments $false
Set-PnPList -Identity "Documents" -EnableVersioning $true
Set-PnPList -Identity "Documents" -MajorVersionLimit 50
```

## üì± Mobile Deployment

### Responsive Design Verification

Test on multiple screen sizes:
- **Desktop**: 1920x1080, 1366x768
- **Tablet**: 1024x768, 768x1024  
- **Mobile**: 375x667, 414x896

### Touch Interface Testing

```javascript
// Test touch events
document.addEventListener('touchstart', function(e) {
    console.log('Touch detected:', e.touches.length);
});
```

## üîÑ Maintenance Procedures

### Regular Updates

#### Weekly Tasks
- Check analytics file size
- Verify personnel data accuracy
- Test key functionality

#### Monthly Tasks  
- Review performance metrics
- Update personnel CSV if needed
- Archive old analytics data

#### Quarterly Tasks
- Full security review
- Permission audit
- Performance optimization

### Backup Strategy

```powershell
# Automated backup script
$backupFolder = "\\server\backups\areamap\"
$date = Get-Date -Format "yyyy-MM-dd"

# Backup all files
Copy-Item "AreaMap.html" "$backupFolder\AreaMap_$date.html"
Copy-Item "personnel_data.csv" "$backupFolder\personnel_$date.csv"
Copy-Item "AreaMapAnalytics.csv" "$backupFolder\analytics_$date.csv"
```

## üö® Troubleshooting Deployment

### Common Issues

#### File Not Found Errors
```javascript
// Debug file path issues
fetch('./personnel_data.csv')
    .then(response => {
        if (!response.ok) {
            console.error('File not found:', response.status);
        }
        return response.text();
    })
    .catch(error => console.error('Fetch error:', error));
```

#### Permission Denied
- Verify user has read access to document library
- Check file-level permissions
- Confirm SharePoint context is available

#### SVG Not Loading
- Verify SVG file is in same directory
- Check file name matches exactly: "Artboard 1.svg"
- Test SVG opens directly in browser

### Deployment Rollback

```powershell
# Quick rollback procedure
1. Navigate to Document Library
2. Select problematic files
3. Go to Version History
4. Restore previous working version
5. Test functionality
```

## üìã Go-Live Checklist

### Pre-Launch
- [ ] All files uploaded successfully
- [ ] Permissions configured correctly
- [ ] Personnel data validated and current
- [ ] Analytics system tested
- [ ] Mobile responsiveness verified
- [ ] Security settings applied

### Launch Day
- [ ] Communicate to end users
- [ ] Monitor for errors in first hour
- [ ] Check analytics data generation
- [ ] Verify performance metrics
- [ ] Document any issues

### Post-Launch
- [ ] Collect user feedback
- [ ] Monitor usage patterns  
- [ ] Schedule regular maintenance
- [ ] Plan future enhancements

---

*This deployment guide ensures a successful, secure, and maintainable installation of the SharePoint Interactive Area Map system.*