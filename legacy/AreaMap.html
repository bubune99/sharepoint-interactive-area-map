<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Map - Personnel Query</title>
    <style>
        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f6fc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        /* Header styles */
        .sharepoint-header {
            background-color: #0078d4;
            color: white;
            padding: 10px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
        }
        .sharepoint-title {
            font-size: 18px;
            font-weight: 600;  n
        }
        /* Map container styles */
        .map-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .svg-map {
            width: 100%;
            height: auto;
            display: block;
        }
        /* Query interface styles */
        .controls-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .control-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .control-input:focus {
            border-color: #0078d4;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        /* Radio button styles */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .radio-label input[type="radio"] {
            margin-right: 6px;
            cursor: pointer;
        }
        /* Results styles */
        .results-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .results-container h3 {
            color: #0078d4;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }
        .personnel-results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .personnel-results-list li {
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .profile-container {
            display: flex;
            align-items: flex-start;
            position: relative;
            padding-top: 20px;
        }
        .profile-image {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
            border: 3px solid #e3f2fd;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .profile-image:hover {
            border-color: #0078d4;
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 120, 212, 0.3);
        }
        .user-details {
            flex: 1;
        }
        .person-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }
        .person-email {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .person-job {
            font-size: 0.9em;
            color: #444;
            font-style: italic;
            margin-bottom: 3px;
        }
        .person-manager {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .manager-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        .manager-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            background: #f8f8f8;
            border-radius: 4px;
        }
        .manager-picture {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .manager-details {
            flex: 1;
        }
        .manager-name {
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
        }
        .manager-title {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }
        .manager-email {
            font-size: 0.8em;
            color: #0078d4;
        }
        .person-areas {
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        .coverage-badge {
            position: absolute;
            top: 0;
            left: 0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }
        .coverage-badge.primary {
            background-color: #0078d4;
        }
        .coverage-badge.secondary {
            background-color: #6b6b6b;
        }
        /* Button styles */
        .control-button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .button-secondary {
            background-color: #f0f0f0;
            color: #333;
            margin-left: 10px;
        }
        /* Side Modal styles - Enhanced */
        .modal-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 420px;
            max-height: calc(100vh - 40px);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 2px solid #e3f2fd;
            backdrop-filter: blur(10px);
        }
        .modal-overlay.show {
            transform: translateX(0) scale(1);
            opacity: 1;
        }
        .modal-overlay.hide {
            transform: translateX(120%) scale(0.95);
            opacity: 0;
        }
        .modal-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .modal-header {
            padding: 24px;
            border-bottom: 2px solid #e3f2fd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            position: relative;
        }
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        .modal-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            z-index: 1;
            position: relative;
        }
        .modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 20px;
            cursor: pointer;
            color: white;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
            z-index: 1;
            position: relative;
        }
        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .modal-close-btn:active {
            transform: scale(0.95);
        }
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
        }
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #0078d4, #106ebe);
            border-radius: 4px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #106ebe, #005a9e);
        }
        .modal-summary {
            font-weight: 600;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f6fc 100%);
            border-radius: 8px;
            border-left: 5px solid #0078d4;
            box-shadow: 0 2px 8px rgba(0, 120, 212, 0.1);
            position: relative;
            overflow: hidden;
        }
        .modal-summary::before {
            content: 'üë•';
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 20px;
            opacity: 0.3;
        }
        .modal-personnel-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-person-card {
            border: 2px solid #e8f4fd;
            border-radius: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .modal-person-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #0078d4, #106ebe);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        .modal-person-card:hover {
            border-color: #b3d9ff;
            box-shadow: 0 4px 16px rgba(0, 120, 212, 0.15);
            transform: translateY(-2px);
        }
        .modal-person-card:hover::before {
            transform: scaleY(1);
        }
        .modal-footer {
            padding: 20px 24px;
            border-top: 2px solid #e3f2fd;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .modal-footer .control-button {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .modal-footer .control-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }
        .modal-footer .control-button:hover::before {
            width: 100px;
            height: 100px;
        }
        
        /* Responsive styles */
        /* Floating animation for modal */
        @keyframes modalFloat {
            0%, 100% { transform: translateX(0) translateY(0) scale(1); }
            50% { transform: translateX(0) translateY(-3px) scale(1.002); }
        }
        
        /* Pulse animation for interactive elements */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 120, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 120, 212, 0); }
        }
        
        /* Shimmer animation for loading states */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .modal-person-card.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            .modal-overlay {
                width: 95%;
                right: 10px;
                top: 10px;
                max-height: calc(100vh - 20px);
                border-radius: 8px;
            }
            .modal-header {
                padding: 16px;
            }
            .modal-body {
                padding: 16px;
            }
            .modal-person-card {
                padding: 16px;
                margin-bottom: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sharepoint-header">
            <div class="sharepoint-title">Area Map - Personnel Query</div>
        </div>
        
        <div class="map-container">
            <!-- SVG Artboard Map -->
            <object id="svg-map" class="svg-map" type="image/svg+xml" data="./Artboard 1-3.svg"></object>
        </div>
        
        <!-- Query Interface -->
        <div class="controls-container">
            <div class="control-group">
                <label class="control-label" for="region-select">Select Region:</label>
                <select id="region-select" class="control-input">
                    <option value="">-- Select Region --</option>
                    <option value="East">East</option>
                    <option value="Central">Central</option>
                    <option value="West">West</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label" for="area-select">Select Area:</label>
                <select id="area-select" class="control-input" disabled>
                    <option value="">-- First Select Region --</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Coverage Type:</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="coverage-type" value="all" checked>
                        All
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="coverage-type" value="primary">
                        Primary Only
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="coverage-type" value="secondary">
                        Secondary Only
                    </label>
                </div>
            </div>
            
            <div class="control-group">
                <button id="query-button" class="control-button">Search</button>
                <button id="reset-button" class="control-button button-secondary">Reset</button>
            </div>
        </div>
        
        
        <!-- Results Container -->
        <div class="results-container">
            <h3>Personnel Details</h3>
            <div id="results-summary">Click on an area or use the search controls above to view personnel</div>
            <ul id="results-list" class="personnel-results-list"></ul>
        </div>
        
        <!-- Modal for Personnel Details -->
        <div id="personnel-modal" class="modal-overlay" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 id="modal-title">Personnel Details</h3>
                    <button id="modal-close" class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="modal-summary" class="modal-summary"></div>
                    <div id="modal-personnel-list" class="modal-personnel-list"></div>
                </div>
                <div class="modal-footer">
                    <button id="modal-close-footer" class="control-button button-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var personnelData = /*@SHAREPOINT_DATA@*/[]/*@END_SHAREPOINT_DATA@*/;
        
        // Automatic CSV logging for admin tracking
        function logAreaClick(areaCode, areaName, region) {
            const clickData = {
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().split(' ')[0],
                areaCode: areaCode,
                areaName: areaName,
                region: region,
                sessionId: generateSessionId(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // Save to localStorage for analytics dashboard
            appendToLocalStorage(clickData);
            
            // Automatically write to CSV file (for admin use)
            writeToCSVFile(clickData);
            
            console.log('Click logged:', clickData);
        }
        
        // Generate unique session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Append to localStorage for analytics dashboard
        function appendToLocalStorage(clickData) {
            try {
                let clickLog = [];
                const saved = localStorage.getItem('areaMapClickLog');
                if (saved) {
                    clickLog = JSON.parse(saved);
                }
                clickLog.push(clickData);
                
                // Keep only last 1000 records to prevent localStorage overflow
                if (clickLog.length > 1000) {
                    clickLog = clickLog.slice(-1000);
                }
                
                localStorage.setItem('areaMapClickLog', JSON.stringify(clickLog));
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }
        }
        
        // Write to AreaMapAnalytics.csv file automatically (for admin tracking)
        function writeToCSVFile(clickData) {
            const csvRow = [
                clickData.timestamp,
                clickData.date,
                clickData.time,
                clickData.areaCode,
                clickData.areaName.replace(/,/g, ';'),
                clickData.region,
                clickData.sessionId,
                `"${clickData.userAgent.replace(/"/g, '""')}"`,
                clickData.url
            ].join(',');
            
            console.log('Appending to AreaMapAnalytics.csv:', csvRow);
            
            // Append to AreaMapAnalytics.csv in the same directory as AreaMap.html
            appendToMasterCSV(csvRow);
        }
        
        // Append data to AreaMapAnalytics.csv file (same directory)
        function appendToMasterCSV(csvRow) {
            // For SharePoint, this will use REST API to append to the CSV file
            const csvFileName = 'AreaMapAnalytics.csv';
            const csvUrl = './' + csvFileName;
            
            if (typeof _spPageContextInfo !== 'undefined') {
                // SharePoint environment - use REST API
                appendToSharePointCSV(csvUrl, csvRow);
            } else {
                // Development/local environment - simulate the append
                console.log('Would append to:', csvUrl);
                console.log('CSV row:', csvRow);
                
                // Store for potential manual export/testing
                if (!window.masterCSVData) {
                    window.masterCSVData = ['Timestamp,Date,Time,AreaCode,AreaName,Region,SessionId,UserAgent,URL'];
                }
                window.masterCSVData.push(csvRow);
                
                // For testing: show updated master CSV content
                console.log('Master CSV content:', window.masterCSVData.join('\\n'));
            }
        }
        
        // SharePoint REST API function to append to CSV file
        function appendToSharePointCSV(csvUrl, csvRow) {
            // First, get the current CSV content
            fetch(csvUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/plain'
                }
            })
            .then(response => response.text())
            .then(currentContent => {
                // Append new row
                const updatedContent = currentContent.trim() + '\\n' + csvRow;
                
                // Update the file using SharePoint REST API
                const fileUrl = _spPageContextInfo.webAbsoluteUrl + 
                    "/_api/web/getfilebyserverrelativeurl('" + 
                    csvUrl.replace(_spPageContextInfo.webAbsoluteUrl, '') + 
                    "')/\\$value";
                
                return fetch(fileUrl, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json;odata=verbose',
                        'X-RequestDigest': document.getElementById('__REQUESTDIGEST').value,
                        'X-HTTP-Method': 'PUT',
                        'Content-Type': 'text/plain'
                    },
                    body: updatedContent
                });
            })
            .then(response => {
                if (response.ok) {
                    console.log('‚úÖ Successfully appended to AreaMapAnalytics.csv');
                } else {
                    console.error('‚ùå Failed to append to AreaMapAnalytics.csv:', response.statusText);
                }
            })
            .catch(error => {
                console.error('‚ùå Error appending to CSV:', error);
                // Fallback: store in localStorage for later retry
                storeForRetry(csvRow);
            });
        }
        
        // Store failed writes for retry
        function storeForRetry(csvRow) {
            try {
                let failedWrites = JSON.parse(localStorage.getItem('failedCSVWrites') || '[]');
                failedWrites.push({
                    timestamp: new Date().toISOString(),
                    csvRow: csvRow
                });
                localStorage.setItem('failedCSVWrites', JSON.stringify(failedWrites));
                console.log('üìù Stored failed write for retry');
            } catch (e) {
                console.error('Failed to store for retry:', e);
            }
        }
        
        // Area name mapping (supports both old and new ID formats)
        var areaNames = {
            // Legacy format support
            'A1': 'Baltimore Coast',
            'A01': 'Baltimore Coast',
            'A2': 'Raleigh',
            'A02': 'Raleigh',
            'A3': 'New England',
            'A03': 'New England',
            'A4': 'New York',
            'A04': 'New York',
            'A5': 'Philadelphia',
            'A05': 'Philadelphia',
            'A6': 'Gulf Coast',
            'A06': 'Gulf Coast',
            'A7': 'Florida',
            'A07': 'Florida',
            'A8': 'Atlanta',
            'A08': 'Atlanta',
            'B1': 'Chicago',
            'B01': 'Chicago',
            'B2': 'Michigan',
            'B02': 'Michigan',
            'B3': 'Ohio Valley',
            'B03': 'Ohio Valley',
            'B4': 'Central Plains',
            'B04': 'Central Plains',
            'B5': 'Minneapolis',
            'B05': 'Minneapolis',
            'B6': 'Nashville',
            'B06': 'Nashville',
            'B7': 'St. Louis',
            'B07': 'St. Louis',
            'B8': 'Tulsa',
            'B08': 'Tulsa',
            'C1': 'Denver',
            'C01': 'Denver',
            'C2': 'Dallas',
            'C02': 'Dallas',
            'C3': 'Houston',
            'C03': 'Houston',
            'C4': 'Phoenix',
            'C04': 'Phoenix',
            'C5': 'Northern California',
            'C05': 'Northern California',
            'C6': 'Seattle',
            'C06': 'Seattle',
            'C7': 'Los Angeles',
            'C07': 'Los Angeles',
            'C8': 'Central Texas',
            'C08': 'Central Texas',
            // New SVG format
            'A01_BaltimoreCoast': 'Baltimore Coast',
            'A02_Raleigh': 'Raleigh',
            'A03_NewEngland': 'New England',
            'A04_NewYork': 'New York',
            'A05_Philadelphia': 'Philadelphia',
            'A06_GulfCoast': 'Gulf Coast',
            'A07_Florida': 'Florida',
            'A08_Atlanta': 'Atlanta',
            'B01_Chicago': 'Chicago',
            'B02_Michigan': 'Michigan',
            'B03_OhioValley': 'Ohio Valley',
            'B04_CentralPlains': 'Central Plains',
            'B05_Minneapolis': 'Minneapolis',
            'B06_Nashville': 'Nashville',
            'B07_StLouis': 'St. Louis',
            'B08_Tulsa': 'Tulsa',
            'C01_Denver': 'Denver',
            'C02_Dallas': 'Dallas',
            'C03_Houston': 'Houston',
            'C04_Phoenix': 'Phoenix',
            'C05_NorthernCalifornia': 'Northern California',
            'C06_Seattle': 'Seattle',
            'C07_LosAngeles': 'Los Angeles',
            'C08_CentralTexas': 'Central Texas'
        };
        
        // Load CSV data if available
        async function loadCSVData() {
            try {
                const response = await fetch('personnel_data.csv');
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                // Only use CSV data if no SharePoint data is loaded
                if (!personnelData || personnelData.length === 0) {
                    personnelData = parsedData;
                    console.log('Loaded personnel data from CSV:', personnelData);
                }
                
                // Perform initial query to show all personnel
                performQuery();
            } catch (error) {
                console.error('Error loading CSV file:', error);
                // Use embedded test data if no CSV and no SharePoint data
                if (!personnelData || personnelData.length === 0) {
                    personnelData = [
                        {
                            "Title": "John Smith",
                            "UserEmail": "john.smith@company.com",
                            "UserDisplayName": "John Smith",
                            "FirstName": "John",
                            "LastName": "Smith",
                            "PreferredFirstName": "Johnny",
                            "UserDepartment": "Sales",
                            "UserJobTitle": "Sales Engineer",
                            "PrimaryAreaIDs": ["A1", "A2"],
                            "SecondaryAreaIDs": ["B1"],
                            "ManagerDisplayName": "Jane Manager",
                            "ManagerEmail": "jane.manager@company.com",
                            "ManagerDepartment": "Sales",
                            "ManagerJobTitle": "Regional Manager"
                        },
                        {
                            "Title": "Jane Manager",
                            "UserEmail": "jane.manager@company.com",
                            "UserDisplayName": "Jane Manager",
                            "FirstName": "Jane",
                            "LastName": "Manager",
                            "UserDepartment": "Sales",
                            "UserJobTitle": "Regional Manager",
                            "PrimaryAreaIDs": ["B1", "B2", "B3"],
                            "SecondaryAreaIDs": [],
                            "ManagerDisplayName": "Tom Director",
                            "ManagerEmail": "tom.director@company.com",
                            "ManagerDepartment": "Executive",
                            "ManagerJobTitle": "Sales Director"
                        },
                        {
                            "Title": "Bob Wilson",
                            "UserEmail": "bob.wilson@company.com",
                            "UserDisplayName": "Bob Wilson",
                            "FirstName": "Robert",
                            "LastName": "Wilson",
                            "PreferredFirstName": "Bob",
                            "UserDepartment": "Technical",
                            "UserJobTitle": "Support Engineer",
                            "PrimaryAreaIDs": ["C1"],
                            "SecondaryAreaIDs": ["A3", "A4"],
                            "ManagerDisplayName": "Jane Manager",
                            "ManagerEmail": "jane.manager@company.com",
                            "ManagerDepartment": "Sales",
                            "ManagerJobTitle": "Regional Manager"
                        },
                        {
                            "Title": "Sarah Lee",
                            "UserEmail": "sarah.lee@company.com",
                            "UserDisplayName": "Sarah Lee",
                            "FirstName": "Sarah",
                            "LastName": "Lee",
                            "UserDepartment": "Marketing",
                            "UserJobTitle": "Marketing Specialist",
                            "PrimaryAreaIDs": ["A2", "A3"],
                            "SecondaryAreaIDs": ["B2", "B3"],
                            "ManagerDisplayName": "Tom Director",
                            "ManagerEmail": "tom.director@company.com",
                            "ManagerDepartment": "Executive",
                            "ManagerJobTitle": "Sales Director"
                        },
                        {
                            "Title": "Tom Director",
                            "UserEmail": "tom.director@company.com",
                            "UserDisplayName": "Tom Director",
                            "FirstName": "Thomas",
                            "LastName": "Director",
                            "PreferredFirstName": "Tom",
                            "UserDepartment": "Executive",
                            "UserJobTitle": "Sales Director",
                            "PrimaryAreaIDs": ["A1", "B1", "C1"],
                            "SecondaryAreaIDs": []
                        }
                    ];
                }
                performQuery();
            }
        }
        
        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',');
                const item = {};
                
                // Parse each field according to CSV structure
                item.Title = values[0] || '';
                item.UserEmail = values[1] || '';
                item.UserDisplayName = values[2] || '';
                item.FirstName = values[3] || '';
                item.LastName = values[4] || '';
                item.PreferredFirstName = values[5] || '';
                item.UserDepartment = values[6] || '';
                item.UserJobTitle = values[7] || '';
                
                // Parse area IDs (semicolon separated)
                item.PrimaryAreaIDs = values[8] ? values[8].split(';').filter(id => id) : [];
                item.SecondaryAreaIDs = values[9] ? values[9].split(';').filter(id => id) : [];
                
                // Manager info
                item.ManagerDisplayName = values[10] || '';
                item.ManagerEmail = values[11] || '';
                item.ManagerDepartment = values[12] || '';
                item.ManagerJobTitle = values[13] || '';
                
                // Create Manager object for compatibility
                item.Manager = item.ManagerDisplayName ? {
                    DisplayName: item.ManagerDisplayName,
                    Email: item.ManagerEmail,
                    Department: item.ManagerDepartment,
                    JobTitle: item.ManagerJobTitle
                } : null;
                
                result.push(item);
            }
            
            return result;
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM Content Loaded - Starting initialization...');
            console.log('Initial personnel data:', personnelData);
            
            
            // Add immediate event listeners first
            setupEventListeners();
            console.log('‚úÖ Event listeners setup complete');
            
            // Then initialize map
            initializeMap();
            console.log('‚úÖ Map initialization started');
            
            // Load CSV data if no SharePoint data is present
            if (!personnelData || personnelData.length === 0) {
                loadCSVData();
            } else {
                // Perform initial query with existing data
                performQuery();
            }
            
            console.log('üéâ Initialization complete!');
        });
        
        // Backup initialization in case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            console.log('üìã Document still loading, waiting for DOMContentLoaded...');
        } else {
            console.log('üìã Document already loaded, initializing immediately...');
            setTimeout(function() {
                setupEventListeners();
                initializeMap();
                if (!personnelData || personnelData.length === 0) {
                    loadCSVData();
                } else {
                    performQuery();
                }
            }, 100);
        }

        // Initialize map and event handlers
        function initializeMap() {
            const svgObject = document.getElementById('svg-map');
            
            // Add error handling for SVG loading
            svgObject.addEventListener('error', function(error) {
                console.error('Error loading SVG:', error);
                alert('Error loading the map. Please ensure the SVG file is in the same folder as this HTML file.');
            });

            svgObject.addEventListener('load', function() {
                const svgDoc = svgObject.contentDocument;
                if (!svgDoc) {
                    console.error('Could not access SVG document');
                    return;
                }

                console.log('SVG loaded successfully');

                // Add styles to SVG
                const style = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'style');
                style.textContent = `
                    path {
                        cursor: pointer;
                        transition: all 0.3s ease !important;
                        opacity: 0.7 !important;
                    }
                    path:hover, path.hover {
                        opacity: 0.9 !important;
                        filter: brightness(1.3) saturate(1.2) !important;
                        transform: scale(1.02) !important;
                        transform-origin: center !important;
                    }
                    path.selected {
                        opacity: 1 !important;
                        filter: brightness(1.4) saturate(1.5) !important;
                        stroke: #0078d4 !important;
                        stroke-width: 2px !important;
                        transform: scale(1.05) !important;
                        transform-origin: center !important;
                    }
                `;
                svgDoc.querySelector('svg').appendChild(style);

                // Add click handlers to all paths
                const paths = svgDoc.querySelectorAll('path');
                console.log(`Found ${paths.length} paths in SVG`);
                
                paths.forEach((path, index) => {
                    const pathId = path.getAttribute('id');
                    console.log(`Attaching events to path ${index}: ${pathId}`);
                    
                    path.addEventListener('click', handleAreaClick);
                    path.addEventListener('mouseenter', handleAreaHover);
                    path.addEventListener('mouseleave', handleAreaLeave);
                    
                    // Test hover effect immediately
                    path.style.transition = 'all 0.3s ease';
                });
                
                console.log('Event handlers attached to all paths');
            });
        }

        // Handle area click
        function handleAreaClick(event) {
            const path = event.target;
            const pathId = path.getAttribute('id');
            if (!pathId) return;
            
            // Clear previous selections
            const svgDoc = path.ownerDocument;
            svgDoc.querySelectorAll('path.selected').forEach(p => {
                p.classList.remove('selected');
                // Reset to default style
                p.style.opacity = '0.7';
                p.style.filter = '';
                p.style.transform = '';
                p.style.stroke = '';
                p.style.strokeWidth = '';
            });
            
            // Select this path
            path.classList.add('selected');
            path.style.opacity = '1';
            path.style.filter = 'brightness(1.4) saturate(1.5)';
            path.style.transform = 'scale(1.05)';
            path.style.transformOrigin = 'center';
            path.style.stroke = '#0078d4';
            path.style.strokeWidth = '2px';
            
            // Extract region and area from path ID
            // Path IDs in new SVG are like "C06_Seattle", "B06_Nashville", "A01_BaltimoreCoast"
            let areaCode, areaName, region;
            
            // First try the new format (full ID as key)
            areaName = areaNames[pathId];
            
            if (!areaName) {
                // Try extracting parts for legacy format
                const parts = pathId.split('_');
                if (parts.length >= 2) {
                    areaCode = parts[0]; // e.g., "C06"
                    const regionCode = areaCode.charAt(0); // e.g., "C"
                    
                    // Map to region names
                    const regionMap = { 'A': 'East', 'B': 'Central', 'C': 'West' };
                    region = regionMap[regionCode];
                    
                    // Try legacy format lookup
                    areaName = areaNames[areaCode];
                    
                    if (!areaName) {
                        // Fallback: extract from path ID and format it
                        const rawName = parts.slice(1).join(' ').replace(/([A-Z])/g, ' $1').trim();
                        areaName = rawName;
                        console.log('Area not found in mapping:', pathId, 'Using:', rawName);
                    }
                } else {
                    console.error('Unable to parse path ID:', pathId);
                    return;
                }
            } else {
                // For new format, extract region from the ID
                const regionCode = pathId.charAt(0);
                const regionMap = { 'A': 'East', 'B': 'Central', 'C': 'West' };
                region = regionMap[regionCode];
                areaCode = pathId.split('_')[0];
            }
            
            console.log('Area clicked:', { pathId, areaCode, areaName, region });
            
            // Log the click for analytics
            if (areaName && region) {
                logAreaClick(areaCode, areaName, region);
            }
            
            // Update dropdowns
            document.getElementById('region-select').value = region;
            updateAreaDropdown(region);
            
            setTimeout(() => {
                if (areaName) {
                    document.getElementById('area-select').value = areaName;
                    performQuery();
                } else {
                    // Force show modal even if area name not found
                    console.log('‚ö†Ô∏è Area name not found, forcing modal display');
                    showPersonnelModal('Test Area', 'Testing modal display', []);
                }
            }, 100);
        }
        
        // Handle area hover
        function handleAreaHover(event) {
            const path = event.target;
            console.log('Hover detected on:', path.getAttribute('id'));
            
            // Add visual hover effect with enhanced styling
            path.classList.add('hover');
            
            // Enhanced hover effects with glow
            path.style.opacity = '0.95';
            path.style.filter = 'brightness(1.4) saturate(1.3) drop-shadow(0 0 8px rgba(0, 120, 212, 0.6))';
            path.style.transform = 'scale(1.03)';
            path.style.transformOrigin = 'center';
            path.style.transition = 'all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
            
            // Add pulse animation
            if (!path.hasAttribute('data-pulse-added')) {
                path.style.animation = 'pulse 2s infinite';
                path.setAttribute('data-pulse-added', 'true');
            }
            
        }
        
        // Handle area leave
        function handleAreaLeave(event) {
            const path = event.target;
            console.log('Mouse left:', path.getAttribute('id'));
            
            // Remove hover class and effects
            path.classList.remove('hover');
            path.style.animation = '';
            path.removeAttribute('data-pulse-added');
            
            // Reset styles only if not selected
            if (!path.classList.contains('selected')) {
                path.style.opacity = '0.7';
                path.style.filter = '';
                path.style.transform = '';
                path.style.transformOrigin = '';
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');
            
            // Region select change handler
            const regionSelect = document.getElementById('region-select');
            const areaSelect = document.getElementById('area-select');
            
            if (!regionSelect) {
                console.error('‚ùå Region select element not found!');
                return;
            }
            if (!areaSelect) {
                console.error('‚ùå Area select element not found!');
                return;
            }

            regionSelect.addEventListener('change', function(event) {
                console.log('üîÑ Region changed:', event.target.value);
                const region = event.target.value;
                updateAreaDropdown(region);
                // Auto-perform query when region changes
                performQuery();
            });

            // Area select change handler
            areaSelect.addEventListener('change', function() {
                console.log('üîÑ Area changed:', event.target.value);
                // Auto-perform query when area changes
                performQuery();
            });
            
            // Query button handler
            const queryBtn = document.getElementById('query-button');
            if (queryBtn) {
                queryBtn.addEventListener('click', function() {
                    console.log('üîç Query button clicked');
                    performQuery();
                });
                console.log('‚úÖ Query button listener added');
            } else {
                console.error('‚ùå Query button not found!');
            }

            // Reset button handler  
            const resetBtn = document.getElementById('reset-button');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    console.log('üîÑ Reset button clicked');
                    resetQuery();
                });
                console.log('‚úÖ Reset button listener added');
            } else {
                console.error('‚ùå Reset button not found!');
            }
            
            console.log('üéØ All basic event listeners setup complete');
        }

        // Update area dropdown based on selected region
        function updateAreaDropdown(region) {
            const areaSelect = document.getElementById('area-select');
            areaSelect.innerHTML = '<option value="">-- Select Area --</option>';
            areaSelect.disabled = !region;

            if (!region) return;

            // Get areas for this region from our mapping
            const regionPrefix = region === 'East' ? 'A' : (region === 'Central' ? 'B' : 'C');
            const areas = [];
            
            // Collect unique area names for this region
            const areaSet = new Set();
            for (const [code, name] of Object.entries(areaNames)) {
                if (code.startsWith(regionPrefix)) {
                    areaSet.add(name);
                }
            }
            
            // Convert to array and sort
            const sortedAreas = Array.from(areaSet).sort();
            
            // Add options to dropdown
            sortedAreas.forEach(areaName => {
                const option = document.createElement('option');
                option.value = areaName;
                option.textContent = areaName;
                areaSelect.appendChild(option);
            });
        }

        // Perform the query based on selected criteria
        function performQuery() {
            const region = document.getElementById('region-select').value;
            const area = document.getElementById('area-select').value;
            const coverageType = document.querySelector('input[name="coverage-type"]:checked')?.value || 'all';

            console.log('üîç Performing query:', { region, area, coverageType });

            // Check if SVG is available before trying to highlight
            const svgObject = document.querySelector('object[data="./Artboard 1-3.svg"]');
            if (svgObject && svgObject.contentDocument) {
                clearAllHighlights();

                // Always show results, even if no region selected
                if (region) {
                    if (area) {
                        highlightArea(region, area);
                    } else {
                        highlightRegion(region);
                    }
                }
            } else {
                console.warn('‚ö†Ô∏è SVG not ready for highlighting, skipping map updates');
            }

            displayQueryResults(region, area, coverageType);
        }

        // Reset the query form and clear highlights
        function resetQuery() {
            console.log('üîÑ Reset button clicked');
            
            // Reset form controls
            document.getElementById('region-select').value = '';
            document.getElementById('area-select').value = '';
            document.getElementById('area-select').disabled = true;
            document.querySelector('input[name="coverage-type"][value="all"]').checked = true;

            // Clear map highlights
            clearAllHighlights();
            
            // Hide modal if open
            hidePersonnelModal();
            
            // Reset results to default message
            document.getElementById('results-summary').textContent = 'Click on an area or use the search controls above to view personnel';
            document.getElementById('results-list').innerHTML = '';
        }

        // Clear all highlights from the map
        function clearAllHighlights() {
            const svgObject = document.querySelector('object[data="./Artboard 1-3.svg"]');
            if (!svgObject) {
                console.warn('‚ö†Ô∏è SVG object not found');
                return;
            }
            
            const svgDoc = svgObject.contentDocument;
            if (!svgDoc) {
                console.warn('‚ö†Ô∏è SVG document not accessible - may still be loading');
                return;
            }

            const paths = svgDoc.querySelectorAll('path');
            console.log(`üßπ Clearing highlights from ${paths.length} paths`);
            paths.forEach(path => {
                path.classList.remove('selected');
                path.classList.remove('hover');
                
                // Reset to default styles
                path.style.opacity = '0.7';
                path.style.filter = '';
                path.style.transform = '';
                path.style.transformOrigin = '';
                path.style.stroke = '';
                path.style.strokeWidth = '';
            });
        }

        // Highlight all areas in a specific region
        function highlightRegion(region) {
            const svgObject = document.querySelector('object[data="./Artboard 1-3.svg"]');
            if (!svgObject) {
                console.warn('‚ö†Ô∏è SVG object not found for region highlighting');
                return;
            }
            
            const svgDoc = svgObject.contentDocument;
            if (!svgDoc) {
                console.warn('‚ö†Ô∏è SVG document not accessible for region highlighting');
                return;
            }

            const regionGroup = svgDoc.querySelector(`#${region}`);
            if (!regionGroup) {
                console.warn(`‚ö†Ô∏è Region group '${region}' not found in SVG`);
                return;
            }

            const paths = regionGroup.querySelectorAll('path');
            console.log(`üéØ Highlighting ${paths.length} paths in region '${region}'`);
            paths.forEach(path => {
                path.classList.add('selected');
            });
        }

        // Highlight a specific area
        function highlightArea(region, area) {
            const svgObject = document.querySelector('object[data="./Artboard 1-3.svg"]');
            if (!svgObject) {
                console.warn('‚ö†Ô∏è SVG object not found for area highlighting');
                return;
            }
            
            const svgDoc = svgObject.contentDocument;
            if (!svgDoc) {
                console.warn('‚ö†Ô∏è SVG document not accessible for area highlighting');
                return;
            }

            // Find all paths in the SVG
            const paths = svgDoc.querySelectorAll('path');
            console.log(`üîç Looking for area '${area}' in ${paths.length} paths`);
            
            // Look for the path that matches this area
            for (const path of paths) {
                const pathId = path.getAttribute('id');
                if (!pathId) continue;

                // First check if the full path ID matches the area name
                if (areaNames[pathId] === area) {
                    console.log(`üéØ Found matching area: ${pathId} for '${area}'`);
                    path.classList.add('selected');
                    break;
                }
                
                // Also check legacy format
                const parts = pathId.split('_');
                if (parts.length >= 1) {
                    const areaCode = parts[0];
                    
                    // Check if this area code maps to our selected area name
                    if (areaNames[areaCode] === area) {
                        console.log(`üéØ Found matching area: ${pathId} for '${area}'`);
                        path.classList.add('selected');
                        break;
                    }
                }
            }
        }

        // Display query results
        function displayQueryResults(region, area, coverageType) {
            console.log('üîÑ displayQueryResults called with:', { region, area, coverageType });
            
            const resultsSummary = document.getElementById('results-summary');
            const resultsList = document.getElementById('results-list');
            
            resultsList.innerHTML = '';

            // Get matching personnel
            const matchingPersonnel = findMatchingPersonnel(region, area, coverageType);
            console.log('Matching personnel:', matchingPersonnel);
            
            // Create summary text
            let summaryText = '';
            let modalTitle = 'Personnel Details';
            
            if (region) {
                if (area) {
                    summaryText = `Found ${matchingPersonnel.length} personnel for ${region} - ${area}`;
                    modalTitle = `${region} - ${area}`;
                } else {
                    summaryText = `Found ${matchingPersonnel.length} personnel for ${region} region`;
                    modalTitle = `${region} Region`;
                }
                if (coverageType !== 'all') {
                    summaryText += ` (${coverageType} coverage only)`;
                    modalTitle += ` (${coverageType} coverage)`;
                }
            } else {
                summaryText = `Showing all ${matchingPersonnel.length} personnel`;
                modalTitle = 'All Personnel';
            }
            
            // Update the summary in the regular results area
            resultsSummary.textContent = summaryText;

            // Always show modal for any search/click (even if no results)
            if (region || area) {
                console.log('üì± About to show modal...', { region, area, personnelCount: matchingPersonnel.length });
                showPersonnelModal(modalTitle, summaryText, matchingPersonnel);
            } else {
                console.log('üì± No region/area selected, skipping modal');
            }

            // Update the regular results list only when modal is NOT shown
            if (!(region || area) || matchingPersonnel.length === 0) {
                if (matchingPersonnel.length > 0) {
                    matchingPersonnel.forEach(person => {
                        const listItem = document.createElement('li');
                        const personCard = createPersonCard(person, false);
                        listItem.appendChild(personCard);
                        resultsList.appendChild(listItem);
                    });
                } else {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = '<em>No personnel found matching the selected criteria</em>';
                    resultsList.appendChild(listItem);
                }
            }
        }
        
        // Show personnel modal with enhanced animations
        function showPersonnelModal(title, summary, personnelList) {
            console.log('showPersonnelModal called with:', { title, summary, personnelCount: personnelList.length });
            
            const modal = document.getElementById('personnel-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSummary = document.getElementById('modal-summary');
            const modalPersonnelList = document.getElementById('modal-personnel-list');
            
            // Add backdrop overlay without blur effect
            let backdrop = document.getElementById('modal-backdrop');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.id = 'modal-backdrop';
                backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.3);
                    z-index: 999;
                    opacity: 0;
                    transition: all 0.4s ease;
                `;
                document.body.appendChild(backdrop);
                
                // Add click handler to close modal when clicking backdrop
                backdrop.addEventListener('click', function(e) {
                    if (e.target === backdrop) {
                        hidePersonnelModal();
                    }
                });
            }
            
            backdrop.style.display = 'block';
            // Force reflow then show
            backdrop.offsetHeight;
            backdrop.style.opacity = '1';
            
            // Set modal content with typing animation for title
            modalTitle.textContent = '';
            modalSummary.textContent = summary;
            
            // Animate title typing
            let titleIndex = 0;
            const typeTitle = () => {
                if (titleIndex < title.length) {
                    modalTitle.textContent += title.charAt(titleIndex);
                    titleIndex++;
                    setTimeout(typeTitle, 50);
                }
            };
            
            // Clear and populate personnel list with staggered animations
            modalPersonnelList.innerHTML = '';
            
            if (personnelList.length > 0) {
                personnelList.forEach((person, index) => {
                    const personCard = createPersonCard(person, true);
                    personCard.style.opacity = '0';
                    personCard.style.transform = 'translateY(20px)';
                    personCard.style.transition = 'all 0.4s ease';
                    modalPersonnelList.appendChild(personCard);
                    
                    // Staggered animation
                    setTimeout(() => {
                        personCard.style.opacity = '1';
                        personCard.style.transform = 'translateY(0)';
                    }, 200 + (index * 100));
                });
            } else {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'modal-person-card';
                emptyMessage.innerHTML = '<em style="color: #666; font-size: 16px;">üîç No personnel found matching the selected criteria</em>';
                emptyMessage.style.textAlign = 'center';
                emptyMessage.style.padding = '40px 20px';
                modalPersonnelList.appendChild(emptyMessage);
            }
            
            // Show modal with enhanced slide animation
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            modal.style.transform = 'translateX(120%) scale(0.95)';
            
            // Force reflow then animate
            modal.offsetHeight;
            modal.style.transition = 'all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)';
            modal.style.opacity = '1';
            modal.style.transform = 'translateX(0) scale(1)';
            modal.classList.add('show');
            
            // Start title typing after modal appears
            setTimeout(typeTitle, 200);
            
            // Add floating animation
            setTimeout(() => {
                modal.style.animation = 'modalFloat 3s ease-in-out infinite';
            }, 600);
            
            // Focus trap for accessibility
            const closeBtn = document.getElementById('modal-close');
            if (closeBtn) {
                setTimeout(() => closeBtn.focus(), 400);
            }
            
            // Add escape key listener
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    hidePersonnelModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }
        
        // Hide personnel modal with enhanced animations
        function hidePersonnelModal() {
            console.log('hidePersonnelModal called');
            const modal = document.getElementById('personnel-modal');
            if (modal) {
                // Remove floating animation
                modal.style.animation = '';
                
                // Slide out animation with scale
                modal.style.transition = 'all 0.3s cubic-bezier(0.55, 0, 0.55, 0.2)';
                modal.style.opacity = '0';
                modal.style.transform = 'translateX(120%) scale(0.9)';
                modal.classList.remove('show');
                modal.classList.add('hide');
                
                // Remove backdrop overlay
                const backdrop = document.getElementById('modal-backdrop');
                if (backdrop) {
                    backdrop.style.opacity = '0';
                    setTimeout(() => {
                        backdrop.style.display = 'none';
                    }, 400);
                }
                
                // Animate person cards out
                const personCards = modal.querySelectorAll('.modal-person-card');
                personCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(-20px)';
                    }, index * 50);
                });
                
                // Hide after animation completes
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('hide');
                    modal.style.transform = '';
                    modal.style.opacity = '';
                    modal.style.transition = '';
                }, 400);
            }
        }
        
        // Create person card element
        function createPersonCard(person, isModal = false) {
            const cardElement = document.createElement('div');
            cardElement.className = isModal ? 'modal-person-card' : 'personnel-card';
            
            const profileContainer = document.createElement('div');
            profileContainer.className = 'profile-container';

            // Add coverage badge
            const coverageType = person.coverageType;
            if (coverageType && coverageType !== 'all') {
                const coverageBadge = document.createElement('div');
                coverageBadge.className = `coverage-badge ${coverageType}`;
                coverageBadge.textContent = coverageType === 'primary' ? 'Primary' : 'Secondary';
                profileContainer.appendChild(coverageBadge);
            }

            const profileImg = document.createElement('img');
            profileImg.className = 'profile-image';
            profileImg.src = person.ProfilePicture || 
                (person.UserEmail ? `/_layouts/15/userphoto.aspx?size=M&accountname=${encodeURIComponent(person.UserEmail)}` :
                'https://via.placeholder.com/50');
            profileImg.alt = 'Profile';
            profileImg.onerror = function() { this.src = 'https://via.placeholder.com/50'; };
            profileContainer.appendChild(profileImg);

            const userDetails = document.createElement('div');
            userDetails.className = 'user-details';

            const nameElement = document.createElement('div');
            nameElement.className = 'person-name';
            const displayFirstName = person.PreferredFirstName || person.FirstName;
            nameElement.textContent = `${displayFirstName} ${person.LastName}`;
            userDetails.appendChild(nameElement);

            const emailElement = document.createElement('div');
            emailElement.className = 'person-email';
            emailElement.textContent = person.UserEmail || person.Email || '';
            userDetails.appendChild(emailElement);

            if (person.UserJobTitle || person.JobTitle) {
                const jobElement = document.createElement('div');
                jobElement.className = 'person-job';
                jobElement.textContent = person.UserJobTitle || person.JobTitle || '';
                userDetails.appendChild(jobElement);
                
                if (person.Manager && person.Manager.DisplayName) {
                    const managerContainer = document.createElement('div');
                    managerContainer.className = 'person-manager';
                    
                    const managerPicture = person.Manager.Picture || 
                        (person.Manager.Email ? `/_layouts/15/userphoto.aspx?size=M&accountname=${encodeURIComponent(person.Manager.Email)}` :
                        'https://via.placeholder.com/32');
                    
                    const managerContent = `
                        <div class="manager-info">
                            <img src="${managerPicture}" class="manager-picture" alt="Manager Picture" onerror="this.src='https://via.placeholder.com/32'">
                            <div class="manager-details">
                                <div class="manager-name">${person.Manager.DisplayName}</div>
                                <div class="manager-title">${person.Manager.JobTitle || ''}</div>
                                <div class="manager-email">${person.Manager.Email || ''}</div>
                            </div>
                        </div>
                    `;
                    
                    managerContainer.innerHTML = `<div class="manager-label">Manager:</div>${managerContent}`;
                    userDetails.appendChild(managerContainer);
                }
            }

            const areasElement = document.createElement('div');
            areasElement.className = 'person-areas';
            const areasToShow = [];
            
            if (person.PrimaryAreaIDs && person.PrimaryAreaIDs.length > 0) {
                const primaryAreas = formatAreasList(person.PrimaryAreaIDs);
                if (primaryAreas) {
                    areasToShow.push(`Primary: ${primaryAreas}`);
                }
            }

            if (person.SecondaryAreaIDs && person.SecondaryAreaIDs.length > 0) {
                const secondaryAreas = formatAreasList(person.SecondaryAreaIDs);
                if (secondaryAreas) {
                    areasToShow.push(`Secondary: ${secondaryAreas}`);
                }
            }

            areasElement.textContent = areasToShow.join(' | ');
            userDetails.appendChild(areasElement);

            profileContainer.appendChild(userDetails);
            cardElement.appendChild(profileContainer);
            
            return cardElement;
        }

        // Find matching personnel
        function findMatchingPersonnel(region, area, coverageType) {
            console.log('Finding personnel for:', { region, area, coverageType });
            console.log('Available personnel:', personnelData);

            // If no region selected, return all personnel
            if (!region) {
                return personnelData.map(person => ({
                    ...person,
                    coverageType: 'all'
                }));
            }

            const results = [];
            
            personnelData.forEach(person => {
                // Get primary and secondary areas
                const primaryAreas = Array.isArray(person.PrimaryAreaIDs) ? person.PrimaryAreaIDs : [];
                const secondaryAreas = Array.isArray(person.SecondaryAreaIDs) ? person.SecondaryAreaIDs : [];

                console.log('Checking person:', person.Title, { primaryAreas, secondaryAreas });

                let matchesPrimary = false;
                let matchesSecondary = false;

                // Get region prefix
                const regionPrefix = region === 'East' ? 'A' : (region === 'Central' ? 'B' : 'C');

                if (area) {
                    // Find all area IDs that match this area name (both formats)
                    let matchingAreaIds = [];
                    for (const [id, name] of Object.entries(areaNames)) {
                        if (id.startsWith(regionPrefix) && name.toLowerCase() === area.toLowerCase()) {
                            matchingAreaIds.push(id);
                            // Also check for alternate format (A01 vs A1)
                            if (id.length === 3) {
                                // If it's A01 format, also check for A1
                                const shortFormat = id.replace(/^([A-C])0/, '$1');
                                if (shortFormat !== id) matchingAreaIds.push(shortFormat);
                            } else if (id.length === 2) {
                                // If it's A1 format, also check for A01
                                const longFormat = id.replace(/^([A-C])/, '$10');
                                if (longFormat !== id) matchingAreaIds.push(longFormat);
                            }
                        }
                    }
                    
                    if (matchingAreaIds.length > 0) {
                        // Check if any of the possible IDs match
                        matchesPrimary = primaryAreas.some(areaId => matchingAreaIds.includes(areaId));
                        matchesSecondary = secondaryAreas.some(areaId => matchingAreaIds.includes(areaId));
                    }
                } else {
                    // If no specific area, check if person has any areas in the region
                    matchesPrimary = primaryAreas.some(areaId => areaId.startsWith(regionPrefix));
                    matchesSecondary = secondaryAreas.some(areaId => areaId.startsWith(regionPrefix));
                }

                // Add person to results based on coverage type
                if (coverageType === 'all') {
                    if (matchesPrimary) {
                        results.push({
                            ...person,
                            coverageType: 'primary'
                        });
                    }
                    if (matchesSecondary) {
                        results.push({
                            ...person,
                            coverageType: 'secondary'
                        });
                    }
                } else if (coverageType === 'primary' && matchesPrimary) {
                    results.push({
                        ...person,
                        coverageType: 'primary'
                    });
                } else if (coverageType === 'secondary' && matchesSecondary) {
                    results.push({
                        ...person,
                        coverageType: 'secondary'
                    });
                }
            });

            console.log('Found matching personnel:', results);
            return results;
        }

        // Format a list of area IDs into readable names
        function formatAreasList(areaIDs) {
            if (!Array.isArray(areaIDs) || areaIDs.length === 0) return '';

            const formattedNames = areaIDs.map(areaId => {
                // Use the areaNames mapping
                return areaNames[areaId] || areaId;
            }).filter(name => name !== '');

            return formattedNames.join(', ');
        }

        // Get region prefix letter
        function getRegionPrefix(region) {
            switch(region) {
                case 'East': return 'A';
                case 'Central': return 'B';
                case 'West': return 'C';
                default: return '';
            }
        }


        // Get region name from prefix
        function getRegionName(prefix) {
            switch(prefix) {
                case 'A': return 'East';
                case 'B': return 'Central';
                case 'C': return 'West';
                default: return '';
            }
        }
        
        // Modal event handlers - Add after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Modal event handlers
            const modalClose = document.getElementById('modal-close');
            const modalCloseFooter = document.getElementById('modal-close-footer');
            
            if (modalClose) {
                modalClose.addEventListener('click', function(e) {
                    console.log('Modal close button clicked');
                    hidePersonnelModal();
                });
            }
            
            if (modalCloseFooter) {
                modalCloseFooter.addEventListener('click', function(e) {
                    console.log('Modal footer close button clicked');
                    hidePersonnelModal();
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('personnel-modal');
                    if (modal && modal.style.display === 'flex') {
                        console.log('Escape key pressed, closing modal');
                        hidePersonnelModal();
                    }
                }
            });
        });
    </script>
</body>
</html>
