<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Map - Personnel Query</title>
    <style>
        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f6fc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        /* Header styles */
        .sharepoint-header {
            background-color: #0078d4;
            color: white;
            padding: 10px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
        }
        .sharepoint-title {
            font-size: 18px;
            font-weight: 600;  n
        }
        /* Map container styles */
        .map-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .svg-map {
            width: 100%;
            height: auto;
            display: block;
        }
        /* Query interface styles */
        .controls-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .control-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .control-input:focus {
            border-color: #0078d4;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        /* Radio button styles */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .radio-label input[type="radio"] {
            margin-right: 6px;
            cursor: pointer;
        }
        /* Results styles */
        .results-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .results-container h3 {
            color: #0078d4;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }
        .personnel-results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .personnel-results-list li {
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .profile-container {
            display: flex;
            align-items: flex-start;
            position: relative;
            padding-top: 20px;
        }
        .profile-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 1px solid #ddd;
        }
        .user-details {
            flex: 1;
        }
        .person-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }
        .person-email {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .person-job {
            font-size: 0.9em;
            color: #444;
            font-style: italic;
            margin-bottom: 3px;
        }
        .person-manager {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .manager-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        .manager-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            background: #f8f8f8;
            border-radius: 4px;
        }
        .manager-picture {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .manager-details {
            flex: 1;
        }
        .manager-name {
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
        }
        .manager-title {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }
        .manager-email {
            font-size: 0.8em;
            color: #0078d4;
        }
        .person-areas {
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        .coverage-badge {
            position: absolute;
            top: 0;
            left: 0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }
        .coverage-badge.primary {
            background-color: #0078d4;
        }
        .coverage-badge.secondary {
            background-color: #6b6b6b;
        }
        /* Button styles */
        .control-button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .button-secondary {
            background-color: #f0f0f0;
            color: #333;
            margin-left: 10px;
        }
        /* Side Modal styles */
        .modal-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            max-height: calc(100vh - 40px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #e0e0e0;
        }
        .modal-overlay.show {
            transform: translateX(0);
        }
        .modal-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
        }
        .modal-header h3 {
            margin: 0;
            color: #0078d4;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .modal-close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .modal-summary {
            font-weight: 500;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f6fc;
            border-radius: 4px;
            border-left: 4px solid #0078d4;
        }
        .modal-personnel-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-person-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background-color: #f8f9fa;
            display: flex;
            justify-content: flex-end;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            .modal-overlay {
                width: 95%;
                right: 10px;
                max-height: calc(100vh - 20px);
            }
            .modal-header {
                padding: 15px;
            }
            .modal-body {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sharepoint-header">
            <div class="sharepoint-title">Area Map - Personnel Query</div>
        </div>
        
        <div class="map-container">
            <!-- SVG Artboard Map -->
            <object id="svg-map" class="svg-map" type="image/svg+xml" data="./Artboard 1.svg"></object>
        </div>
        
        <!-- Query Interface -->
        <div class="controls-container">
            <div class="control-group">
                <label class="control-label" for="region-select">Select Region:</label>
                <select id="region-select" class="control-input">
                    <option value="">-- Select Region --</option>
                    <option value="East">East</option>
                    <option value="Central">Central</option>
                    <option value="West">West</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label" for="area-select">Select Area:</label>
                <select id="area-select" class="control-input" disabled>
                    <option value="">-- First Select Region --</option>
                </select>
            </div>
            
            <div class="control-group">
                <label class="control-label">Coverage Type:</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="coverage-type" value="all" checked>
                        All
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="coverage-type" value="primary">
                        Primary Only
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="coverage-type" value="secondary">
                        Secondary Only
                    </label>
                </div>
            </div>
            
            <div class="control-group">
                <button id="query-button" class="control-button">Search</button>
                <button id="reset-button" class="control-button button-secondary">Reset</button>
                <button id="analytics-button" class="control-button button-secondary" style="margin-left: 10px;">ðŸ“Š Analytics</button>
            </div>
        </div>
        
        <!-- Analytics Panel -->
        <div id="analytics-panel" class="controls-container" style="display: none;">
            <h3>ðŸ“Š Usage Analytics</h3>
            <div class="control-group">
                <div id="analytics-summary"></div>
            </div>
            <div class="control-group">
                <button id="export-analytics" class="control-button">Export Data</button>
                <button id="view-analytics" class="control-button button-secondary">View Details</button>
                <button id="clear-analytics" class="control-button" style="background-color: #d13438;">Clear Data</button>
                <button id="close-analytics" class="control-button button-secondary">Close</button>
            </div>
        </div>
        
        <!-- Results Container -->
        <div class="results-container">
            <h3>Personnel Details</h3>
            <div id="results-summary">Click on an area or use the search controls above to view personnel</div>
            <ul id="results-list" class="personnel-results-list"></ul>
        </div>
        
        <!-- Modal for Personnel Details -->
        <div id="personnel-modal" class="modal-overlay" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 id="modal-title">Personnel Details</h3>
                    <button id="modal-close" class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="modal-summary" class="modal-summary"></div>
                    <div id="modal-personnel-list" class="modal-personnel-list"></div>
                </div>
                <div class="modal-footer">
                    <button id="modal-close-footer" class="control-button button-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var personnelData = /*@SHAREPOINT_DATA@*/[]/*@END_SHAREPOINT_DATA@*/;
        
        // Analytics tracking system
        var analytics = {
            sessionId: generateSessionId(),
            startTime: new Date().toISOString(),
            events: {
                areaHovers: {},      // Track hover counts per area
                areaClicks: {},      // Track click counts per area
                queries: {           // Track query executions
                    total: 0,
                    byRegion: {},
                    byArea: {},
                    byCoverageType: {}
                },
                sessions: []         // Track session data
            },
            
            // Initialize analytics from localStorage
            init: function() {
                const saved = localStorage.getItem('areaMapAnalytics');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.events = { ...this.events, ...data };
                    } catch (e) {
                        console.log('Could not load analytics data:', e);
                    }
                }
                
                // Record session start
                this.events.sessions.push({
                    sessionId: this.sessionId,
                    startTime: this.startTime,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                });
                
                this.save();
            },
            
            // Save analytics to localStorage
            save: function() {
                try {
                    localStorage.setItem('areaMapAnalytics', JSON.stringify(this.events));
                } catch (e) {
                    console.log('Could not save analytics data:', e);
                }
            },
            
            // Track area hover
            trackHover: function(areaCode, areaName) {
                const key = `${areaCode}_${areaName}`;
                this.events.areaHovers[key] = (this.events.areaHovers[key] || 0) + 1;
                this.save();
                console.log(`Hover tracked: ${areaName} (${this.events.areaHovers[key]} times)`);
            },
            
            // Track area click
            trackClick: function(areaCode, areaName) {
                const key = `${areaCode}_${areaName}`;
                this.events.areaClicks[key] = (this.events.areaClicks[key] || 0) + 1;
                this.save();
                console.log(`Click tracked: ${areaName} (${this.events.areaClicks[key]} times)`);
            },
            
            // Track query execution
            trackQuery: function(region, area, coverageType) {
                this.events.queries.total++;
                
                if (region) {
                    this.events.queries.byRegion[region] = (this.events.queries.byRegion[region] || 0) + 1;
                }
                
                if (area) {
                    this.events.queries.byArea[area] = (this.events.queries.byArea[area] || 0) + 1;
                }
                
                this.events.queries.byCoverageType[coverageType] = (this.events.queries.byCoverageType[coverageType] || 0) + 1;
                
                this.save();
                console.log(`Query tracked: Region=${region}, Area=${area}, Coverage=${coverageType}`);
            },
            
            // Get analytics summary
            getSummary: function() {
                return {
                    sessionInfo: {
                        sessionId: this.sessionId,
                        startTime: this.startTime,
                        totalSessions: this.events.sessions.length
                    },
                    interactions: {
                        totalHovers: Object.values(this.events.areaHovers).reduce((a, b) => a + b, 0),
                        totalClicks: Object.values(this.events.areaClicks).reduce((a, b) => a + b, 0),
                        totalQueries: this.events.queries.total,
                        mostHoveredAreas: this.getTopAreas(this.events.areaHovers, 5),
                        mostClickedAreas: this.getTopAreas(this.events.areaClicks, 5),
                        popularRegions: this.events.queries.byRegion,
                        coverageTypePreferences: this.events.queries.byCoverageType
                    },
                    rawData: this.events
                };
            },
            
            // Get top areas by interaction count
            getTopAreas: function(data, limit = 5) {
                return Object.entries(data)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, limit)
                    .map(([key, count]) => ({
                        area: key.split('_').slice(1).join(' '),
                        count: count
                    }));
            },
            
            // Export analytics data
            exportData: function() {
                const data = this.getSummary();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `area-map-analytics-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // Clear analytics data
            clearData: function() {
                if (confirm('Are you sure you want to clear all analytics data? This cannot be undone.')) {
                    localStorage.removeItem('areaMapAnalytics');
                    this.events = {
                        areaHovers: {},
                        areaClicks: {},
                        queries: { total: 0, byRegion: {}, byArea: {}, byCoverageType: {} },
                        sessions: []
                    };
                    this.init();
                    console.log('Analytics data cleared');
                }
            }
        };
        
        // Generate unique session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Area name mapping (supports both A1 and A01 formats)
        var areaNames = {
            'A1': 'Baltimore Coast',
            'A01': 'Baltimore Coast',
            'A2': 'South East',
            'A02': 'South East',
            'A3': 'New England',
            'A03': 'New England',
            'A4': 'New York',
            'A04': 'New York',
            'A5': 'Philadelphia',
            'A05': 'Philadelphia',
            'A6': 'Gulf Coast',
            'A06': 'Gulf Coast',
            'A7': 'Florida',
            'A07': 'Florida',
            'B1': 'Chicago',
            'B01': 'Chicago',
            'B2': 'Michigan',
            'B02': 'Michigan',
            'B3': 'Ohio Valley',
            'B03': 'Ohio Valley',
            'B4': 'Central Plains',
            'B04': 'Central Plains',
            'B5': 'North Central',
            'B05': 'North Central',
            'B6': 'Nashville',
            'B06': 'Nashville',
            'B7': 'St. Louis',
            'B07': 'St. Louis',
            'B8': 'Tulsa',
            'B08': 'Tulsa',
            'C1': 'Denver',
            'C01': 'Denver',
            'C2': 'Dallas',
            'C02': 'Dallas',
            'C3': 'Houston',
            'C03': 'Houston',
            'C4': 'Phoenix',
            'C04': 'Phoenix',
            'C5': 'Northern California',
            'C05': 'Northern California',
            'C6': 'Seattle',
            'C06': 'Seattle',
            'C7': 'Los Angeles',
            'C07': 'Los Angeles'
        };
        
        // Load CSV data if available
        async function loadCSVData() {
            try {
                const response = await fetch('personnel_data.csv');
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                // Only use CSV data if no SharePoint data is loaded
                if (!personnelData || personnelData.length === 0) {
                    personnelData = parsedData;
                    console.log('Loaded personnel data from CSV:', personnelData);
                }
                
                // Perform initial query to show all personnel
                performQuery();
            } catch (error) {
                console.error('Error loading CSV file:', error);
                // Use embedded test data if no CSV and no SharePoint data
                if (!personnelData || personnelData.length === 0) {
                    personnelData = [
                        {
                            "Title": "John Smith",
                            "UserEmail": "john.smith@company.com",
                            "UserDisplayName": "John Smith",
                            "FirstName": "John",
                            "LastName": "Smith",
                            "PreferredFirstName": "Johnny",
                            "UserDepartment": "Sales",
                            "UserJobTitle": "Sales Engineer",
                            "PrimaryAreaIDs": ["A1", "A2"],
                            "SecondaryAreaIDs": ["B1"],
                            "ManagerDisplayName": "Jane Manager",
                            "ManagerEmail": "jane.manager@company.com",
                            "ManagerDepartment": "Sales",
                            "ManagerJobTitle": "Regional Manager"
                        },
                        {
                            "Title": "Jane Manager",
                            "UserEmail": "jane.manager@company.com",
                            "UserDisplayName": "Jane Manager",
                            "FirstName": "Jane",
                            "LastName": "Manager",
                            "UserDepartment": "Sales",
                            "UserJobTitle": "Regional Manager",
                            "PrimaryAreaIDs": ["B1", "B2", "B3"],
                            "SecondaryAreaIDs": [],
                            "ManagerDisplayName": "Tom Director",
                            "ManagerEmail": "tom.director@company.com",
                            "ManagerDepartment": "Executive",
                            "ManagerJobTitle": "Sales Director"
                        },
                        {
                            "Title": "Bob Wilson",
                            "UserEmail": "bob.wilson@company.com",
                            "UserDisplayName": "Bob Wilson",
                            "FirstName": "Robert",
                            "LastName": "Wilson",
                            "PreferredFirstName": "Bob",
                            "UserDepartment": "Technical",
                            "UserJobTitle": "Support Engineer",
                            "PrimaryAreaIDs": ["C1"],
                            "SecondaryAreaIDs": ["A3", "A4"],
                            "ManagerDisplayName": "Jane Manager",
                            "ManagerEmail": "jane.manager@company.com",
                            "ManagerDepartment": "Sales",
                            "ManagerJobTitle": "Regional Manager"
                        },
                        {
                            "Title": "Sarah Lee",
                            "UserEmail": "sarah.lee@company.com",
                            "UserDisplayName": "Sarah Lee",
                            "FirstName": "Sarah",
                            "LastName": "Lee",
                            "UserDepartment": "Marketing",
                            "UserJobTitle": "Marketing Specialist",
                            "PrimaryAreaIDs": ["A2", "A3"],
                            "SecondaryAreaIDs": ["B2", "B3"],
                            "ManagerDisplayName": "Tom Director",
                            "ManagerEmail": "tom.director@company.com",
                            "ManagerDepartment": "Executive",
                            "ManagerJobTitle": "Sales Director"
                        },
                        {
                            "Title": "Tom Director",
                            "UserEmail": "tom.director@company.com",
                            "UserDisplayName": "Tom Director",
                            "FirstName": "Thomas",
                            "LastName": "Director",
                            "PreferredFirstName": "Tom",
                            "UserDepartment": "Executive",
                            "UserJobTitle": "Sales Director",
                            "PrimaryAreaIDs": ["A1", "B1", "C1"],
                            "SecondaryAreaIDs": []
                        }
                    ];
                }
                performQuery();
            }
        }
        
        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',');
                const item = {};
                
                // Parse each field according to CSV structure
                item.Title = values[0] || '';
                item.UserEmail = values[1] || '';
                item.UserDisplayName = values[2] || '';
                item.FirstName = values[3] || '';
                item.LastName = values[4] || '';
                item.PreferredFirstName = values[5] || '';
                item.UserDepartment = values[6] || '';
                item.UserJobTitle = values[7] || '';
                
                // Parse area IDs (semicolon separated)
                item.PrimaryAreaIDs = values[8] ? values[8].split(';').filter(id => id) : [];
                item.SecondaryAreaIDs = values[9] ? values[9].split(';').filter(id => id) : [];
                
                // Manager info
                item.ManagerDisplayName = values[10] || '';
                item.ManagerEmail = values[11] || '';
                item.ManagerDepartment = values[12] || '';
                item.ManagerJobTitle = values[13] || '';
                
                // Create Manager object for compatibility
                item.Manager = item.ManagerDisplayName ? {
                    DisplayName: item.ManagerDisplayName,
                    Email: item.ManagerEmail,
                    Department: item.ManagerDepartment,
                    JobTitle: item.ManagerJobTitle
                } : null;
                
                result.push(item);
            }
            
            return result;
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initial personnel data:', personnelData);
            
            // Initialize analytics tracking
            analytics.init();
            
            initializeMap();
            setupEventListeners();
            
            // Load CSV data if no SharePoint data is present
            if (!personnelData || personnelData.length === 0) {
                loadCSVData();
            } else {
                // Perform initial query with existing data
                performQuery();
            }
        });

        // Initialize map and event handlers
        function initializeMap() {
            const svgObject = document.getElementById('svg-map');
            
            // Add error handling for SVG loading
            svgObject.addEventListener('error', function(error) {
                console.error('Error loading SVG:', error);
                alert('Error loading the map. Please ensure the SVG file is in the same folder as this HTML file.');
            });

            svgObject.addEventListener('load', function() {
                const svgDoc = svgObject.contentDocument;
                if (!svgDoc) {
                    console.error('Could not access SVG document');
                    return;
                }

                console.log('SVG loaded successfully');

                // Add styles to SVG
                const style = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'style');
                style.textContent = `
                    path {
                        cursor: pointer;
                        transition: all 0.3s ease !important;
                        opacity: 0.7 !important;
                    }
                    path:hover, path.hover {
                        opacity: 0.9 !important;
                        filter: brightness(1.3) saturate(1.2) !important;
                        transform: scale(1.02) !important;
                        transform-origin: center !important;
                    }
                    path.selected {
                        opacity: 1 !important;
                        filter: brightness(1.4) saturate(1.5) !important;
                        stroke: #0078d4 !important;
                        stroke-width: 2px !important;
                        transform: scale(1.05) !important;
                        transform-origin: center !important;
                    }
                `;
                svgDoc.querySelector('svg').appendChild(style);

                // Add click handlers to all paths
                const paths = svgDoc.querySelectorAll('path');
                console.log(`Found ${paths.length} paths in SVG`);
                
                paths.forEach((path, index) => {
                    const pathId = path.getAttribute('id');
                    console.log(`Attaching events to path ${index}: ${pathId}`);
                    
                    path.addEventListener('click', handleAreaClick);
                    path.addEventListener('mouseenter', handleAreaHover);
                    path.addEventListener('mouseleave', handleAreaLeave);
                    
                    // Test hover effect immediately
                    path.style.transition = 'all 0.3s ease';
                });
                
                console.log('Event handlers attached to all paths');
            });
        }

        // Handle area click
        function handleAreaClick(event) {
            const path = event.target;
            const pathId = path.getAttribute('id');
            if (!pathId) return;
            
            // Clear previous selections
            const svgDoc = path.ownerDocument;
            svgDoc.querySelectorAll('path.selected').forEach(p => {
                p.classList.remove('selected');
                // Reset to default style
                p.style.opacity = '0.7';
                p.style.filter = '';
                p.style.transform = '';
                p.style.stroke = '';
                p.style.strokeWidth = '';
            });
            
            // Select this path
            path.classList.add('selected');
            path.style.opacity = '1';
            path.style.filter = 'brightness(1.4) saturate(1.5)';
            path.style.transform = 'scale(1.05)';
            path.style.transformOrigin = 'center';
            path.style.stroke = '#0078d4';
            path.style.strokeWidth = '2px';
            
            // Extract region and area from path ID
            // Path IDs are like "C06_Seattle", "B06_Nashville", "A01_Baltimore"
            const parts = pathId.split('_');
            if (parts.length < 2) return;
            
            const areaCode = parts[0]; // e.g., "C06"
            const regionCode = areaCode.charAt(0); // e.g., "C"
            const areaNameFromId = parts[1]; // e.g., "Seattle"
            
            // Map to region names
            const regionMap = { 'A': 'East', 'B': 'Central', 'C': 'West' };
            const region = regionMap[regionCode];
            
            // Get the area name from our mapping
            const areaName = areaNames[areaCode];
            if (!areaName) {
                // Fallback: extract from path ID and format it
                const rawName = parts[1].replace(/_/g, ' ');
                console.log('Area not found in mapping:', areaCode, 'Using:', rawName);
            }
            
            console.log('Area clicked:', { pathId, areaCode, areaName, region });
            
            // Track click analytics
            if (areaName) {
                analytics.trackClick(areaCode, areaName);
            }
            
            // Update dropdowns
            document.getElementById('region-select').value = region;
            updateAreaDropdown(region);
            
            setTimeout(() => {
                if (areaName) {
                    document.getElementById('area-select').value = areaName;
                    performQuery();
                }
            }, 100);
        }
        
        // Handle area hover
        function handleAreaHover(event) {
            const path = event.target;
            console.log('Hover detected on:', path.getAttribute('id'));
            
            // Add visual hover effect with immediate styling
            path.classList.add('hover');
            
            // Force immediate style update to ensure hover effect is visible
            path.style.opacity = '0.9';
            path.style.filter = 'brightness(1.3) saturate(1.2)';
            path.style.transform = 'scale(1.02)';
            path.style.transformOrigin = 'center';
            path.style.transition = 'all 0.3s ease';
            
            // Track hover analytics
            const pathId = path.getAttribute('id');
            if (pathId) {
                const parts = pathId.split('_');
                if (parts.length >= 2) {
                    const areaCode = parts[0];
                    const areaName = areaNames[areaCode];
                    if (areaName) {
                        analytics.trackHover(areaCode, areaName);
                        console.log(`Hover tracked: ${areaName} (${areaCode})`);
                    } else {
                        console.log(`Area name not found for code: ${areaCode}`);
                    }
                }
            }
        }
        
        // Handle area leave
        function handleAreaLeave(event) {
            const path = event.target;
            console.log('Mouse left:', path.getAttribute('id'));
            
            // Remove hover class
            path.classList.remove('hover');
            
            // Reset styles only if not selected
            if (!path.classList.contains('selected')) {
                path.style.opacity = '0.7';
                path.style.filter = '';
                path.style.transform = '';
                path.style.transformOrigin = '';
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Region select change handler
            const regionSelect = document.getElementById('region-select');
            const areaSelect = document.getElementById('area-select');

            regionSelect.addEventListener('change', function(event) {
                const region = event.target.value;
                updateAreaDropdown(region);
                // Auto-perform query when region changes
                performQuery();
            });

            // Area select change handler
            areaSelect.addEventListener('change', function() {
                // Auto-perform query when area changes
                performQuery();
            });
            
            // Query button handler
            document.getElementById('query-button').addEventListener('click', performQuery);

            // Reset button handler  
            document.getElementById('reset-button').addEventListener('click', resetQuery);
        }

        // Update area dropdown based on selected region
        function updateAreaDropdown(region) {
            const areaSelect = document.getElementById('area-select');
            areaSelect.innerHTML = '<option value="">-- Select Area --</option>';
            areaSelect.disabled = !region;

            if (!region) return;

            // Get areas for this region from our mapping
            const regionPrefix = region === 'East' ? 'A' : (region === 'Central' ? 'B' : 'C');
            const areas = [];
            
            // Collect unique area names for this region
            const areaSet = new Set();
            for (const [code, name] of Object.entries(areaNames)) {
                if (code.startsWith(regionPrefix)) {
                    areaSet.add(name);
                }
            }
            
            // Convert to array and sort
            const sortedAreas = Array.from(areaSet).sort();
            
            // Add options to dropdown
            sortedAreas.forEach(areaName => {
                const option = document.createElement('option');
                option.value = areaName;
                option.textContent = areaName;
                areaSelect.appendChild(option);
            });
        }

        // Perform the query based on selected criteria
        function performQuery() {
            const region = document.getElementById('region-select').value;
            const area = document.getElementById('area-select').value;
            const coverageType = document.querySelector('input[name="coverage-type"]:checked')?.value || 'all';

            // Track query analytics
            analytics.trackQuery(region, area, coverageType);

            clearAllHighlights();

            // Always show results, even if no region selected
            if (region) {
                if (area) {
                    highlightArea(region, area);
                } else {
                    highlightRegion(region);
                }
            }

            displayQueryResults(region, area, coverageType);
        }

        // Reset the query form and clear highlights
        function resetQuery() {
            console.log('ðŸ”„ Reset button clicked');
            
            // Reset form controls
            document.getElementById('region-select').value = '';
            document.getElementById('area-select').value = '';
            document.getElementById('area-select').disabled = true;
            document.querySelector('input[name="coverage-type"][value="all"]').checked = true;

            // Clear map highlights
            clearAllHighlights();
            
            // Hide modal if open
            hidePersonnelModal();
            
            // Reset results to default message
            document.getElementById('results-summary').textContent = 'Click on an area or use the search controls above to view personnel';
            document.getElementById('results-list').innerHTML = '';
        }

        // Clear all highlights from the map
        function clearAllHighlights() {
            const svgDoc = document.querySelector('object[data="Artboard 1.svg"]').contentDocument;
            if (!svgDoc) return;

            const paths = svgDoc.querySelectorAll('path');
            paths.forEach(path => {
                path.classList.remove('selected');
                path.classList.remove('hover');
                
                // Reset to default styles
                path.style.opacity = '0.7';
                path.style.filter = '';
                path.style.transform = '';
                path.style.transformOrigin = '';
                path.style.stroke = '';
                path.style.strokeWidth = '';
            });
        }

        // Highlight all areas in a specific region
        function highlightRegion(region) {
            const svgDoc = document.querySelector('object[data="Artboard 1.svg"]').contentDocument;
            if (!svgDoc) return;

            const regionGroup = svgDoc.querySelector(`#${region}`);
            if (!regionGroup) return;

            const paths = regionGroup.querySelectorAll('path');
            paths.forEach(path => {
                path.classList.add('selected');
            });
        }

        // Highlight a specific area
        function highlightArea(region, area) {
            const svgDoc = document.querySelector('object[data="Artboard 1.svg"]').contentDocument;
            if (!svgDoc) return;

            // Find all paths in the SVG
            const paths = svgDoc.querySelectorAll('path');
            
            // Look for the path that matches this area
            for (const path of paths) {
                const pathId = path.getAttribute('id');
                if (!pathId) continue;

                // Extract area code from path ID
                const parts = pathId.split('_');
                if (parts.length < 2) continue;
                
                const areaCode = parts[0];
                
                // Check if this area code maps to our selected area name
                if (areaNames[areaCode] === area) {
                    path.classList.add('selected');
                    break;
                }
            }
        }

        // Display query results
        function displayQueryResults(region, area, coverageType) {
            console.log('ðŸ”„ displayQueryResults called with:', { region, area, coverageType });
            
            const resultsSummary = document.getElementById('results-summary');
            const resultsList = document.getElementById('results-list');
            
            resultsList.innerHTML = '';

            // Get matching personnel
            const matchingPersonnel = findMatchingPersonnel(region, area, coverageType);
            console.log('Matching personnel:', matchingPersonnel);
            
            // Create summary text
            let summaryText = '';
            let modalTitle = 'Personnel Details';
            
            if (region) {
                if (area) {
                    summaryText = `Found ${matchingPersonnel.length} personnel for ${region} - ${area}`;
                    modalTitle = `${region} - ${area}`;
                } else {
                    summaryText = `Found ${matchingPersonnel.length} personnel for ${region} region`;
                    modalTitle = `${region} Region`;
                }
                if (coverageType !== 'all') {
                    summaryText += ` (${coverageType} coverage only)`;
                    modalTitle += ` (${coverageType} coverage)`;
                }
            } else {
                summaryText = `Showing all ${matchingPersonnel.length} personnel`;
                modalTitle = 'All Personnel';
            }
            
            // Update the summary in the regular results area
            resultsSummary.textContent = summaryText;

            // Show modal if there are personnel to display and it's an actual search/click
            if (matchingPersonnel.length > 0 && (region || area)) {
                console.log('ðŸ“± About to show modal...');
                showPersonnelModal(modalTitle, summaryText, matchingPersonnel);
            } else if (matchingPersonnel.length === 0 && (region || area)) {
                // Show modal even for empty results if it's a specific search
                console.log('ðŸ“± Showing modal for empty results...');
                showPersonnelModal(modalTitle, summaryText, []);
            }

            // Update the regular results list only when modal is NOT shown
            if (!(region || area) || matchingPersonnel.length === 0) {
                if (matchingPersonnel.length > 0) {
                    matchingPersonnel.forEach(person => {
                        const listItem = document.createElement('li');
                        const personCard = createPersonCard(person, false);
                        listItem.appendChild(personCard);
                        resultsList.appendChild(listItem);
                    });
                } else {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = '<em>No personnel found matching the selected criteria</em>';
                    resultsList.appendChild(listItem);
                }
            }
        }
        
        // Show personnel modal
        function showPersonnelModal(title, summary, personnelList) {
            console.log('showPersonnelModal called with:', { title, summary, personnelCount: personnelList.length });
            
            const modal = document.getElementById('personnel-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSummary = document.getElementById('modal-summary');
            const modalPersonnelList = document.getElementById('modal-personnel-list');
            
            // Set modal content
            modalTitle.textContent = title;
            modalSummary.textContent = summary;
            
            // Clear and populate personnel list
            modalPersonnelList.innerHTML = '';
            
            if (personnelList.length > 0) {
                personnelList.forEach((person, index) => {
                    const personCard = createPersonCard(person, true);
                    modalPersonnelList.appendChild(personCard);
                });
            } else {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'modal-person-card';
                emptyMessage.innerHTML = '<em>No personnel found matching the selected criteria</em>';
                modalPersonnelList.appendChild(emptyMessage);
            }
            
            // Show modal with slide animation
            modal.style.display = 'flex';
            
            // Force reflow then add show class for animation
            modal.offsetHeight;
            modal.classList.add('show');
            
            // Focus trap for accessibility
            const closeBtn = document.getElementById('modal-close');
            if (closeBtn) {
                closeBtn.focus();
            }
        }
        
        // Hide personnel modal
        function hidePersonnelModal() {
            console.log('hidePersonnelModal called');
            const modal = document.getElementById('personnel-modal');
            if (modal) {
                // Slide out animation
                modal.classList.remove('show');
                
                // Hide after animation completes
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }
        
        // Create person card element
        function createPersonCard(person, isModal = false) {
            const cardElement = document.createElement('div');
            cardElement.className = isModal ? 'modal-person-card' : 'personnel-card';
            
            const profileContainer = document.createElement('div');
            profileContainer.className = 'profile-container';

            // Add coverage badge
            const coverageType = person.coverageType;
            if (coverageType && coverageType !== 'all') {
                const coverageBadge = document.createElement('div');
                coverageBadge.className = `coverage-badge ${coverageType}`;
                coverageBadge.textContent = coverageType === 'primary' ? 'Primary' : 'Secondary';
                profileContainer.appendChild(coverageBadge);
            }

            const profileImg = document.createElement('img');
            profileImg.className = 'profile-image';
            profileImg.src = person.ProfilePicture || 
                (person.UserEmail ? `/_layouts/15/userphoto.aspx?size=M&accountname=${encodeURIComponent(person.UserEmail)}` :
                'https://via.placeholder.com/50');
            profileImg.alt = 'Profile';
            profileImg.onerror = function() { this.src = 'https://via.placeholder.com/50'; };
            profileContainer.appendChild(profileImg);

            const userDetails = document.createElement('div');
            userDetails.className = 'user-details';

            const nameElement = document.createElement('div');
            nameElement.className = 'person-name';
            const displayFirstName = person.PreferredFirstName || person.FirstName;
            nameElement.textContent = `${displayFirstName} ${person.LastName}`;
            userDetails.appendChild(nameElement);

            const emailElement = document.createElement('div');
            emailElement.className = 'person-email';
            emailElement.textContent = person.UserEmail || person.Email || '';
            userDetails.appendChild(emailElement);

            if (person.UserJobTitle || person.JobTitle) {
                const jobElement = document.createElement('div');
                jobElement.className = 'person-job';
                jobElement.textContent = person.UserJobTitle || person.JobTitle || '';
                userDetails.appendChild(jobElement);
                
                if (person.Manager && person.Manager.DisplayName) {
                    const managerContainer = document.createElement('div');
                    managerContainer.className = 'person-manager';
                    
                    const managerPicture = person.Manager.Picture || 
                        (person.Manager.Email ? `/_layouts/15/userphoto.aspx?size=M&accountname=${encodeURIComponent(person.Manager.Email)}` :
                        'https://via.placeholder.com/32');
                    
                    const managerContent = `
                        <div class="manager-info">
                            <img src="${managerPicture}" class="manager-picture" alt="Manager Picture" onerror="this.src='https://via.placeholder.com/32'">
                            <div class="manager-details">
                                <div class="manager-name">${person.Manager.DisplayName}</div>
                                <div class="manager-title">${person.Manager.JobTitle || ''}</div>
                                <div class="manager-email">${person.Manager.Email || ''}</div>
                            </div>
                        </div>
                    `;
                    
                    managerContainer.innerHTML = `<div class="manager-label">Manager:</div>${managerContent}`;
                    userDetails.appendChild(managerContainer);
                }
            }

            const areasElement = document.createElement('div');
            areasElement.className = 'person-areas';
            const areasToShow = [];
            
            if (person.PrimaryAreaIDs && person.PrimaryAreaIDs.length > 0) {
                const primaryAreas = formatAreasList(person.PrimaryAreaIDs);
                if (primaryAreas) {
                    areasToShow.push(`Primary: ${primaryAreas}`);
                }
            }

            if (person.SecondaryAreaIDs && person.SecondaryAreaIDs.length > 0) {
                const secondaryAreas = formatAreasList(person.SecondaryAreaIDs);
                if (secondaryAreas) {
                    areasToShow.push(`Secondary: ${secondaryAreas}`);
                }
            }

            areasElement.textContent = areasToShow.join(' | ');
            userDetails.appendChild(areasElement);

            profileContainer.appendChild(userDetails);
            cardElement.appendChild(profileContainer);
            
            return cardElement;
        }

        // Find matching personnel
        function findMatchingPersonnel(region, area, coverageType) {
            console.log('Finding personnel for:', { region, area, coverageType });
            console.log('Available personnel:', personnelData);

            // If no region selected, return all personnel
            if (!region) {
                return personnelData.map(person => ({
                    ...person,
                    coverageType: 'all'
                }));
            }

            const results = [];
            
            personnelData.forEach(person => {
                // Get primary and secondary areas
                const primaryAreas = Array.isArray(person.PrimaryAreaIDs) ? person.PrimaryAreaIDs : [];
                const secondaryAreas = Array.isArray(person.SecondaryAreaIDs) ? person.SecondaryAreaIDs : [];

                console.log('Checking person:', person.Title, { primaryAreas, secondaryAreas });

                let matchesPrimary = false;
                let matchesSecondary = false;

                // Get region prefix
                const regionPrefix = region === 'East' ? 'A' : (region === 'Central' ? 'B' : 'C');

                if (area) {
                    // Find all area IDs that match this area name (both formats)
                    let matchingAreaIds = [];
                    for (const [id, name] of Object.entries(areaNames)) {
                        if (id.startsWith(regionPrefix) && name.toLowerCase() === area.toLowerCase()) {
                            matchingAreaIds.push(id);
                            // Also check for alternate format (A01 vs A1)
                            if (id.length === 3) {
                                // If it's A01 format, also check for A1
                                const shortFormat = id.replace(/^([A-C])0/, '$1');
                                if (shortFormat !== id) matchingAreaIds.push(shortFormat);
                            } else if (id.length === 2) {
                                // If it's A1 format, also check for A01
                                const longFormat = id.replace(/^([A-C])/, '$10');
                                if (longFormat !== id) matchingAreaIds.push(longFormat);
                            }
                        }
                    }
                    
                    if (matchingAreaIds.length > 0) {
                        // Check if any of the possible IDs match
                        matchesPrimary = primaryAreas.some(areaId => matchingAreaIds.includes(areaId));
                        matchesSecondary = secondaryAreas.some(areaId => matchingAreaIds.includes(areaId));
                    }
                } else {
                    // If no specific area, check if person has any areas in the region
                    matchesPrimary = primaryAreas.some(areaId => areaId.startsWith(regionPrefix));
                    matchesSecondary = secondaryAreas.some(areaId => areaId.startsWith(regionPrefix));
                }

                // Add person to results based on coverage type
                if (coverageType === 'all') {
                    if (matchesPrimary) {
                        results.push({
                            ...person,
                            coverageType: 'primary'
                        });
                    }
                    if (matchesSecondary) {
                        results.push({
                            ...person,
                            coverageType: 'secondary'
                        });
                    }
                } else if (coverageType === 'primary' && matchesPrimary) {
                    results.push({
                        ...person,
                        coverageType: 'primary'
                    });
                } else if (coverageType === 'secondary' && matchesSecondary) {
                    results.push({
                        ...person,
                        coverageType: 'secondary'
                    });
                }
            });

            console.log('Found matching personnel:', results);
            return results;
        }

        // Format a list of area IDs into readable names
        function formatAreasList(areaIDs) {
            if (!Array.isArray(areaIDs) || areaIDs.length === 0) return '';

            const formattedNames = areaIDs.map(areaId => {
                // Use the areaNames mapping
                return areaNames[areaId] || areaId;
            }).filter(name => name !== '');

            return formattedNames.join(', ');
        }

        // Get region prefix letter
        function getRegionPrefix(region) {
            switch(region) {
                case 'East': return 'A';
                case 'Central': return 'B';
                case 'West': return 'C';
                default: return '';
            }
        }


        // Get region name from prefix
        function getRegionName(prefix) {
            switch(prefix) {
                case 'A': return 'East';
                case 'B': return 'Central';
                case 'C': return 'West';
                default: return '';
            }
        }
        
        // Analytics event handlers - Add after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Analytics button handlers
            document.getElementById('analytics-button').addEventListener('click', showAnalyticsPanel);
            document.getElementById('close-analytics').addEventListener('click', hideAnalyticsPanel);
            document.getElementById('export-analytics').addEventListener('click', function() {
                analytics.exportData();
            });
            document.getElementById('view-analytics').addEventListener('click', showAnalyticsDetails);
            document.getElementById('clear-analytics').addEventListener('click', function() {
                analytics.clearData();
                updateAnalyticsSummary();
            });
            
            // Modal event handlers
            const modalClose = document.getElementById('modal-close');
            const modalCloseFooter = document.getElementById('modal-close-footer');
            
            if (modalClose) {
                modalClose.addEventListener('click', function(e) {
                    console.log('Modal close button clicked');
                    hidePersonnelModal();
                });
            }
            
            if (modalCloseFooter) {
                modalCloseFooter.addEventListener('click', function(e) {
                    console.log('Modal footer close button clicked');
                    hidePersonnelModal();
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('personnel-modal');
                    if (modal && modal.style.display === 'flex') {
                        console.log('Escape key pressed, closing modal');
                        hidePersonnelModal();
                    }
                }
            });
        });
        
        // Show analytics panel
        function showAnalyticsPanel() {
            document.getElementById('analytics-panel').style.display = 'block';
            updateAnalyticsSummary();
        }
        
        // Hide analytics panel
        function hideAnalyticsPanel() {
            document.getElementById('analytics-panel').style.display = 'none';
        }
        
        // Update analytics summary display
        function updateAnalyticsSummary() {
            const summary = analytics.getSummary();
            const summaryDiv = document.getElementById('analytics-summary');
            
            summaryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 10px; background: #f0f6fc; border-radius: 4px;">
                        <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${summary.interactions.totalHovers}</div>
                        <div style="font-size: 12px; color: #666;">Total Hovers</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f0f6fc; border-radius: 4px;">
                        <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${summary.interactions.totalClicks}</div>
                        <div style="font-size: 12px; color: #666;">Total Clicks</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f0f6fc; border-radius: 4px;">
                        <div style="font-size: 24px; font-weight: bold; color: #0078d4;">${summary.interactions.totalQueries}</div>
                        <div style="font-size: 12px; color: #666;">Total Queries</div>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Most Popular Areas (Clicks):</strong><br>
                    ${summary.interactions.mostClickedAreas.slice(0, 3).map(area => 
                        `â€¢ ${area.area}: ${area.count} clicks`
                    ).join('<br>') || 'No data yet'}
                </div>
                <div style="font-size: 12px; color: #666;">
                    Session: ${summary.sessionInfo.sessionId}<br>
                    Total Sessions Recorded: ${summary.sessionInfo.totalSessions}
                </div>
            `;
        }
        
        // Show detailed analytics in console and alert
        function showAnalyticsDetails() {
            const summary = analytics.getSummary();
            console.log('Detailed Analytics:', summary);
            
            alert(`Detailed Analytics:
            
Session Info:
â€¢ Session ID: ${summary.sessionInfo.sessionId}
â€¢ Total Sessions: ${summary.sessionInfo.totalSessions}

Interactions:
â€¢ Total Hovers: ${summary.interactions.totalHovers}
â€¢ Total Clicks: ${summary.interactions.totalClicks}
â€¢ Total Queries: ${summary.interactions.totalQueries}

Most Clicked Areas:
${summary.interactions.mostClickedAreas.map(area => `â€¢ ${area.area}: ${area.count}`).join('\n')}

Popular Regions:
${Object.entries(summary.interactions.popularRegions).map(([region, count]) => `â€¢ ${region}: ${count}`).join('\n')}

Coverage Preferences:
${Object.entries(summary.interactions.coverageTypePreferences).map(([type, count]) => `â€¢ ${type}: ${count}`).join('\n')}

See browser console for full data.`);
        }
    </script>
</body>
</html>
